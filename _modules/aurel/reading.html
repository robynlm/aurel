

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>aurel.reading &mdash; aurel May 2025 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
      <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=5a7fad61" />

  
    <link rel="shortcut icon" href="../../_static/favicon.png"/>
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=8d170800"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            aurel
              <img src="../../_static/aurel.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../source/readme_sections.html">Key Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/readme_sections.html#installation">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/readme_sections.html#getting-started">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/readme_sections.html#citation">Citation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/advice.html">Working on an HPC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/advice.html#convergence">Convergence</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/CONTRIBUTING.html">Reporting Issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/CONTRIBUTING.html#code-contributions">Code Contributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/CONTRIBUTING.html#license">License</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../source/core.html">aurel.core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/coresymbolic.html">aurel.coresymbolic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/finitedifference.html">aurel.finitedifference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/maths.html">aurel.maths</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/numerical.html">aurel.numerical</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/reading.html">aurel.reading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/time.html">aurel.time</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/solutions.html">aurel.solutions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/Example.html">Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/Example_symbolic.html">Example symbolic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/Example_over_time.html">Example over time</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/tov_ET.html">tov_ET</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/ICPertFLRW.html">ICPertFLRW</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/Schwarzschild_check.html">Schwarzschild check</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/Analytic_check.html">Analytic check</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/Gravitational_Waves.html">Gravitational Waves</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">aurel</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">aurel.reading</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for aurel.reading</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">reading.py</span>

<span class="sd">This module provides comprehensive functionality for reading and writing </span>
<span class="sd">numerical relativity simulation data, with specialized support for </span>
<span class="sd">Einstein Toolkit (ET) simulations. The module handles complex data structures </span>
<span class="sd">including multiple restart files, chunked data, variable groupings, and </span>
<span class="sd">different refinement levels.</span>

<span class="sd">Key functions relevant for Aurel: ``read_data`` and ``save_data``.</span>
<span class="sd">All other functions are auxiliary utilities for Einstein Toolkit data handling.</span>

<span class="sd">Core Einstein Toolkit Functionality</span>
<span class="sd">-----------------------------------</span>
<span class="sd">- **Parameter extraction**: Read simulation parameters from .par files</span>
<span class="sd">- **Iteration management**: List and track available simulation iterations</span>
<span class="sd">- **Content listing**: List available variables and their file associations</span>
<span class="sd">- **Data reading**: Read 3D simulation data from HDF5 files</span>
<span class="sd">- **Data chunking**: Join data chunks from distributed file systems</span>
<span class="sd">- **Caching**: Save/load data in per-iteration formats for faster access</span>

<span class="sd">Environment Setup</span>
<span class="sd">-----------------</span>
<span class="sd">Users must set the SIMLOC environment variable to the simulation directories:</span>

<span class="sd">    ``export SIMLOC=&quot;/path/to/simulations/&quot;``</span>

<span class="sd">For multiple simulation locations, use colon separation on Unix/Mac or semicolon on Windows:</span>

<span class="sd">    ``export SIMLOC=&quot;/path1:/path2:/path3&quot;``  # Unix/Mac</span>
<span class="sd">    </span>
<span class="sd">    ``set SIMLOC=&quot;C:\\path1;C:\\path2;C:\\path3&quot;``  # Windows</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">h5py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">contextlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>

<span class="n">aurel_tensor_to_scalar</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;gammadown3&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;gxx&#39;</span><span class="p">,</span> <span class="s1">&#39;gxy&#39;</span><span class="p">,</span> <span class="s1">&#39;gxz&#39;</span><span class="p">,</span> <span class="s1">&#39;gyy&#39;</span><span class="p">,</span> <span class="s1">&#39;gyz&#39;</span><span class="p">,</span> <span class="s1">&#39;gzz&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Kdown3&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;kxx&#39;</span><span class="p">,</span> <span class="s1">&#39;kxy&#39;</span><span class="p">,</span> <span class="s1">&#39;kxz&#39;</span><span class="p">,</span> <span class="s1">&#39;kyy&#39;</span><span class="p">,</span> <span class="s1">&#39;kyz&#39;</span><span class="p">,</span> <span class="s1">&#39;kzz&#39;</span><span class="p">],</span>
    <span class="s1">&#39;betaup3&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;betax&#39;</span><span class="p">,</span> <span class="s1">&#39;betay&#39;</span><span class="p">,</span> <span class="s1">&#39;betaz&#39;</span><span class="p">],</span>
    <span class="s1">&#39;dtbetaup3&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;dtbetax&#39;</span><span class="p">,</span> <span class="s1">&#39;dtbetay&#39;</span><span class="p">,</span> <span class="s1">&#39;dtbetaz&#39;</span><span class="p">],</span>
    <span class="s1">&#39;velup3&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;velx&#39;</span><span class="p">,</span> <span class="s1">&#39;vely&#39;</span><span class="p">,</span> <span class="s1">&#39;velz&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Momentumup3&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Momentumx&#39;</span><span class="p">,</span> <span class="s1">&#39;Momentumy&#39;</span><span class="p">,</span> <span class="s1">&#39;Momentumz&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Weyl_Psi&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Weyl_Psi4r&#39;</span><span class="p">,</span> <span class="s1">&#39;Weyl_Psi4i&#39;</span><span class="p">],</span>
<span class="p">}</span>

<div class="viewcode-block" id="transform_vars_tensor_to_scalar">
<a class="viewcode-back" href="../../source/reading.html#aurel.reading.transform_vars_tensor_to_scalar">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">transform_vars_tensor_to_scalar</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transform Aurel tensor variable names to their scalar component names.</span>

<span class="sd">    This function decomposes tensor quantities into their individual scalar</span>
<span class="sd">    components for detailed analysis. For example, the 3-metric &#39;gammadown3&#39;</span>
<span class="sd">    becomes [&#39;gxx&#39;, &#39;gxy&#39;, &#39;gxz&#39;, &#39;gyy&#39;, &#39;gyz&#39;, &#39;gzz&#39;].</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    var : list of str</span>
<span class="sd">        List of Aurel tensor variable names to transform.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of str</span>
<span class="sd">        List of scalar variable names. Tensor variables are expanded to their</span>
<span class="sd">        components, while scalar variables are kept as-is.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">var_scalars</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">var</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">aurel_tensor_to_scalar</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">var_scalars</span> <span class="o">+=</span> <span class="n">aurel_tensor_to_scalar</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">var_scalars</span> <span class="o">+=</span> <span class="p">[</span><span class="n">v</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">var_scalars</span></div>


<div class="viewcode-block" id="read_data">
<a class="viewcode-back" href="../../source/reading.html#aurel.reading.read_data">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">read_data</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read simulation data from Aurel or Einstein Toolkit format files.</span>

<span class="sd">    This is the main entry point for reading numerical relativity simulation </span>
<span class="sd">    data. It automatically detects the data format and routes to the </span>
<span class="sd">    appropriate reading function. Supports both Einstein Toolkit HDF5 output </span>
<span class="sd">    and Aurel&#39;s optimized per-iteration format.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    param : dict</span>
<span class="sd">        Simulation parameters dictionary containing metadata about the </span>
<span class="sd">        simulation. If &#39;simulation&#39; key is present, treats as Einstein Toolkit</span>
<span class="sd">        data; otherwise treats as Aurel format. In Einstein Toolkit case, you</span>
<span class="sd">        can use the parameters function.</span>

<span class="sd">    Other Parameters</span>
<span class="sd">    ----------------</span>
<span class="sd">    it : list of int, optional</span>
<span class="sd">        Iteration numbers to read. Default [0].</span>

<span class="sd">    vars : list of str, optional  </span>
<span class="sd">        Variable names to read. Default [] (read all available).</span>

<span class="sd">    rl : int, optional</span>
<span class="sd">        Refinement level to read. Default 0 (coarsest level).</span>

<span class="sd">    restart : int, optional</span>
<span class="sd">        Specific restart number to read from. Default -1 (auto-detect).</span>
<span class="sd">        Set to specific value to read from that restart only.</span>

<span class="sd">    split_per_it : bool, optional</span>
<span class="sd">        For ET data: whether to use per-iteration files. Default True.</span>
<span class="sd">        When True, reads from cached files and fills missing data from ET </span>
<span class="sd">        files, then saves newly read ET data to per-iteration files.</span>
<span class="sd">        When False, reads exclusively from ET files.</span>

<span class="sd">    usecheckpoints : bool, optional</span>
<span class="sd">        For ET data: whether to use checkpoint iterations if available. </span>
<span class="sd">        Default False.</span>

<span class="sd">    verbose : bool, optional</span>
<span class="sd">        Print detailed progress information. Default False.</span>

<span class="sd">    veryverbose : bool, optional</span>
<span class="sd">        Print very detailed debugging information. Default False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Dictionary containing the simulation data with keys::</span>

<span class="sd">            {</span>
<span class="sd">                &#39;it&#39;: [iteration_numbers], # ints</span>
<span class="sd">                &#39;t&#39;: [time_values],        # floats or None if not available</span>
<span class="sd">                &#39;var1&#39;: [data_arrays],     # arrays or Nones if not available</span>
<span class="sd">                &#39;var2&#39;: [data_arrays],</span>
<span class="sd">                ...</span>
<span class="sd">            }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">it</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;it&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]))))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;it can not be an empty list. &#39;</span>
            <span class="o">+</span> <span class="s1">&#39;Please provide at least one iteration number to read.&#39;</span><span class="p">)</span>

    <span class="c1"># Determine data format and route to appropriate reader</span>
    <span class="c1"># Einstein Toolkit data has &#39;simulation&#39; key in parameters</span>
    <span class="k">if</span> <span class="s1">&#39;simulation&#39;</span> <span class="ow">in</span> <span class="n">param</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">read_ET_data</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Aurel format data (per-iteration HDF5 files)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">read_aurel_data</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="read_aurel_data">
<a class="viewcode-back" href="../../source/reading.html#aurel.reading.read_aurel_data">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">read_aurel_data</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read data from Aurel format simulation output files.</span>

<span class="sd">    Aurel format stores simulation data in per-iteration HDF5 files with the </span>
<span class="sd">    naming convention &#39;it_&lt;iteration&gt;.hdf5&#39;. Each file contains variables </span>
<span class="sd">    organized by refinement level with keys like &#39;varname rl=0&#39;.</span>

<span class="sd">    This format is optimized for easy parallelization across iterations.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    param : dict</span>
<span class="sd">        Simulation parameters dictionary. Must contain either:</span>
<span class="sd">        - &#39;datapath&#39;: Direct path to directory with it_*.hdf5 files, OR</span>
<span class="sd">        - &#39;simulation&#39;, &#39;simpath&#39;, &#39;simname&#39;: For ET-style directory structure</span>

<span class="sd">    Other Parameters</span>
<span class="sd">    ----------------</span>
<span class="sd">    it : list of int, optional</span>
<span class="sd">        Iteration numbers to read. Default [0].</span>
<span class="sd">        </span>
<span class="sd">    vars : list of str, optional</span>
<span class="sd">        Variable names to read. Default [] (read all available variables).</span>
<span class="sd">        </span>
<span class="sd">    rl : int, optional</span>
<span class="sd">        Refinement level to read. Default 0.</span>
<span class="sd">        </span>
<span class="sd">    restart : int, optional</span>
<span class="sd">        Restart number (for ET-style directory structure). Default 0.</span>
<span class="sd">        </span>
<span class="sd">    verbose : bool, optional</span>
<span class="sd">        Print progress information. Default False.</span>
<span class="sd">        </span>
<span class="sd">    veryverbose : bool, optional</span>
<span class="sd">        Print detailed debugging information. Default False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Dictionary with simulation data::</span>

<span class="sd">            {</span>
<span class="sd">                &#39;it&#39;: [iteration_numbers], # ints</span>
<span class="sd">                &#39;t&#39;: [time_values],        # floats or None if not available</span>
<span class="sd">                &#39;var1&#39;: [data_arrays],     # arrays or Nones if not available</span>
<span class="sd">                &#39;var2&#39;: [data_arrays],</span>
<span class="sd">                ...</span>
<span class="sd">            }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Extract reading parameters with defaults</span>
    <span class="n">it</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;it&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]))))</span>
    <span class="n">rl</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">restart</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;restart&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">var</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vars&#39;</span><span class="p">,</span> <span class="p">[])))</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;verbose&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">veryverbose</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;veryverbose&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Determine if we should read all variables or specific ones</span>
    <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="n">get_them_all</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">get_them_all</span> <span class="o">=</span> <span class="kc">False</span>
        
    <span class="k">if</span> <span class="n">veryverbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;read_aurel_data: looking for it &#39;</span><span class="p">,</span> <span class="n">it</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">get_them_all</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;read_aurel_data: reading all variables available&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;read_aurel_data: reading variables </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>

    <span class="c1"># Construct data directory path based on parameter structure</span>
    <span class="k">if</span> <span class="s1">&#39;simulation&#39;</span> <span class="ow">in</span> <span class="n">param</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="c1"># Einstein Toolkit style directory structure</span>
        <span class="n">datapath</span> <span class="o">=</span> <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;simpath&#39;</span><span class="p">]</span>
                    <span class="o">+</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;simname&#39;</span><span class="p">]</span>
                    <span class="o">+</span> <span class="s1">&#39;/output-</span><span class="si">{:04d}</span><span class="s1">/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">restart</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;simname&#39;</span><span class="p">]</span>
                 <span class="o">+</span> <span class="s1">&#39;/all_iterations/&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Direct path to Aurel format files</span>
        <span class="n">datapath</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;datapath&#39;</span><span class="p">]</span>
        
    <span class="c1"># Always include time coordinate in variables to read</span>
    <span class="n">var</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span>
    <span class="c1"># Initialize data dictionary with empty lists for each variable</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;it&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">it</span><span class="p">),</span> <span class="o">**</span><span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">var</span><span class="p">}}</span>
    
    <span class="c1"># Read data for each requested iteration</span>
    <span class="k">for</span> <span class="n">it_index</span><span class="p">,</span> <span class="n">iit</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">it</span><span class="p">):</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">it_</span><span class="si">{}</span><span class="s1">.hdf5&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datapath</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">iit</span><span class="p">))</span>
        
        <span class="c1"># Handle missing iteration files gracefully</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
            <span class="c1"># Record None values for all variables at this iteration</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">var</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># File exists - read data from HDF5 file</span>
            <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">get_them_all</span><span class="p">:</span>
                    <span class="c1"># Scan file for variables at this rl</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">if</span> <span class="s1">&#39; rl=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rl</span><span class="p">)</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                            <span class="n">var</span> <span class="o">+=</span> <span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; rl&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="n">var</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>  <span class="c1"># Remove duplicates</span>
                    <span class="c1"># Remove &#39;it&#39; - not a file variable</span>
                    <span class="n">var</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">var</span> <span class="k">if</span> <span class="n">v</span> <span class="o">!=</span> <span class="s1">&#39;it&#39;</span><span class="p">]</span>
                    
                <span class="c1"># Read each requested variable</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">var</span><span class="p">:</span>
                    <span class="n">skey</span> <span class="o">=</span> <span class="n">key</span> <span class="o">+</span> <span class="s1">&#39; rl=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rl</span><span class="p">)</span>  <span class="c1"># HDF5 dataset key</span>
                    
                    <span class="c1"># Ensure this variable exists in our data dictionary</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">it_index</span> <span class="c1"># Fill iterations with None</span>
                        
                    <span class="c1"># Read data if dataset exists, otherwise store None</span>
                    <span class="k">if</span> <span class="n">skey</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">skey</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="save_data">
<a class="viewcode-back" href="../../source/reading.html#aurel.reading.save_data">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">save_data</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Save simulation data to Aurel format HDF5 files.</span>

<span class="sd">    Saves simulation data in the per-iteration format used by Aurel, where each</span>
<span class="sd">    iteration is stored in a separate HDF5 file named &#39;it_&lt;iteration&gt;.hdf5&#39;.</span>
<span class="sd">    Variables are stored as datasets with keys like &#39;varname rl=&lt;level&gt;&#39;.</span>

<span class="sd">    This format provides several advantages:</span>

<span class="sd">    - Fast random access to specific iterations</span>
<span class="sd">    - Parallel I/O capabilities </span>
<span class="sd">    - Efficient storage for sparse temporal sampling</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    param : dict</span>
<span class="sd">        Simulation parameters dictionary containing path information.</span>
<span class="sd">        Should include either:</span>
<span class="sd">        - &#39;datapath&#39;: Direct path where files will be saved, OR  </span>
<span class="sd">        - &#39;simulation&#39; &#39;simpath&#39;, &#39;simname&#39;: For ET-style directory structure</span>

<span class="sd">    data : dict</span>
<span class="sd">        Dictionary containing simulation data to save.</span>
<span class="sd">        Expected structure::</span>

<span class="sd">            {</span>
<span class="sd">                &#39;it&#39;: [iteration_numbers],</span>
<span class="sd">                &#39;t&#39;: [time_values], </span>
<span class="sd">                &#39;var1&#39;: [data_arrays],</span>
<span class="sd">                &#39;var2&#39;: [data_arrays],</span>
<span class="sd">                ...</span>
<span class="sd">            }</span>

<span class="sd">        Each variable should have one array per iteration.</span>

<span class="sd">    Other Parameters</span>
<span class="sd">    ----------------</span>

<span class="sd">    vars : list of str, optional</span>
<span class="sd">        Variables to save. Default [] (save all variables in data).</span>
<span class="sd">        Note: &#39;it&#39; and &#39;t&#39; are automatically included if present.</span>

<span class="sd">    it : list of int, optional  </span>
<span class="sd">        Iterations to save. Default [0].</span>

<span class="sd">    rl : int, optional</span>
<span class="sd">        Refinement level for saved data. Default 0.</span>
<span class="sd">        Used in HDF5 dataset keys: &#39;varname rl=&lt;rl&gt;&#39;</span>
<span class="sd">        Can just represent grids of different shapes.</span>

<span class="sd">    restart : int, optional</span>
<span class="sd">        Restart number (for ET-style paths). Default 0.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Overwrites existing datasets with the same name</span>
<span class="sd">    - Skips variables with None values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">vars</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vars&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">it</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;it&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]))))</span>
    <span class="n">rl</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">restart</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;restart&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">vars</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="nb">vars</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">if</span> <span class="s1">&#39;it&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">vars</span> <span class="ow">and</span> <span class="s1">&#39;it&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="nb">vars</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;it&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;t&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">vars</span> <span class="ow">and</span> <span class="s1">&#39;t&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="nb">vars</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span>

    <span class="c1"># check paths</span>
    <span class="k">if</span> <span class="s1">&#39;simulation&#39;</span> <span class="ow">in</span> <span class="n">param</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="c1"># ET-style directory structure</span>
        <span class="n">datapath</span> <span class="o">=</span> <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;simpath&#39;</span><span class="p">]</span>
                 <span class="o">+</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;simname&#39;</span><span class="p">]</span>
                 <span class="o">+</span> <span class="s1">&#39;/output-</span><span class="si">{:04d}</span><span class="s1">/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">restart</span><span class="p">)</span>
                 <span class="o">+</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;simname&#39;</span><span class="p">]</span>
                 <span class="o">+</span> <span class="s1">&#39;/all_iterations/&#39;</span><span class="p">)</span>
        <span class="n">lastpart</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">datapath</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;datapath&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">datapath</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
            <span class="n">lastpart</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lastpart</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">datapath</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">datapath</span><span class="p">)</span>
    <span class="n">datapath</span> <span class="o">+=</span> <span class="n">lastpart</span>

    <span class="c1"># save the data</span>
    <span class="k">for</span> <span class="n">it_index</span><span class="p">,</span> <span class="n">iit</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">it</span><span class="p">):</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">it_</span><span class="si">{}</span><span class="s1">.hdf5&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datapath</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">iit</span><span class="p">))</span>
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">skey</span> <span class="o">=</span> <span class="n">key</span> <span class="o">+</span> <span class="s1">&#39; rl=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rl</span><span class="p">)</span>
                    <span class="c1"># TODO: are you sure about overwriting?</span>
                    <span class="k">if</span> <span class="n">skey</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="n">skey</span><span class="p">]</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">skey</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">it_index</span><span class="p">])</span></div>


<span class="c1">###############################################################################</span>
<span class="c1">###############################################################################</span>
<span class="c1">#</span>
<span class="c1">#                  Einstein Toolkit specific functions</span>
<span class="c1">#</span>
<span class="c1">###############################################################################</span>
<span class="c1">###############################################################################</span>

<span class="c1"># =============================================================================</span>
<span class="c1">#                   Aurel to Einstein Toolkit variables</span>
<span class="c1"># =============================================================================</span>

<span class="n">aurel_to_ET_varnames</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;gammadown3&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;gxx&#39;</span><span class="p">,</span> <span class="s1">&#39;gxy&#39;</span><span class="p">,</span> <span class="s1">&#39;gxz&#39;</span><span class="p">,</span> <span class="s1">&#39;gyy&#39;</span><span class="p">,</span> <span class="s1">&#39;gyz&#39;</span><span class="p">,</span> <span class="s1">&#39;gzz&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Kdown3&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;kxx&#39;</span><span class="p">,</span> <span class="s1">&#39;kxy&#39;</span><span class="p">,</span> <span class="s1">&#39;kxz&#39;</span><span class="p">,</span> <span class="s1">&#39;kyy&#39;</span><span class="p">,</span> <span class="s1">&#39;kyz&#39;</span><span class="p">,</span> <span class="s1">&#39;kzz&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Ktrace&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;trK&#39;</span><span class="p">],</span>
    <span class="s1">&#39;alpha&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;alp&#39;</span><span class="p">],</span>
    <span class="s1">&#39;dtalpha&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;dtalp&#39;</span><span class="p">],</span>
    <span class="s1">&#39;betaup3&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;betax&#39;</span><span class="p">,</span> <span class="s1">&#39;betay&#39;</span><span class="p">,</span> <span class="s1">&#39;betaz&#39;</span><span class="p">],</span>
    <span class="s1">&#39;dtbetaup3&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;dtbetax&#39;</span><span class="p">,</span> <span class="s1">&#39;dtbetay&#39;</span><span class="p">,</span> <span class="s1">&#39;dtbetaz&#39;</span><span class="p">],</span>
    <span class="s1">&#39;rho0&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;rho&#39;</span><span class="p">],</span>
    <span class="s1">&#39;eps&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;eps&#39;</span><span class="p">],</span>
    <span class="s1">&#39;press&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;press&#39;</span><span class="p">],</span>
    <span class="s1">&#39;w_lorentz&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;w_lorentz&#39;</span><span class="p">],</span>
    <span class="s1">&#39;velup3&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;vel[0]&#39;</span><span class="p">,</span> <span class="s1">&#39;vel[1]&#39;</span><span class="p">,</span> <span class="s1">&#39;vel[2]&#39;</span><span class="p">],</span>
    <span class="s1">&#39;velx&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;vel[0]&#39;</span><span class="p">],</span>
    <span class="s1">&#39;vely&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;vel[1]&#39;</span><span class="p">],</span>
    <span class="s1">&#39;velz&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;vel[2]&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Hamiltonian&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Momentumup3&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;M1&#39;</span><span class="p">,</span> <span class="s1">&#39;M2&#39;</span><span class="p">,</span> <span class="s1">&#39;M3&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Momentumx&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;M1&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Momentumy&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;M2&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Momentumz&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;M3&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Weyl_Psi&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Psi4r&#39;</span><span class="p">,</span> <span class="s1">&#39;Psi4i&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Weyl_Psi4r&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Psi4r&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Weyl_Psi4i&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Psi4i&#39;</span><span class="p">]</span>
<span class="p">}</span>
<div class="viewcode-block" id="transform_vars_aurel_to_ET">
<a class="viewcode-back" href="../../source/reading.html#aurel.reading.transform_vars_aurel_to_ET">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">transform_vars_aurel_to_ET</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transform ET variable names to Aurel variable names.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    var : list of str</span>
<span class="sd">        List of variable names to transform.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of str</span>
<span class="sd">        List of transformed variable names.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">var_ET</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">var</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">aurel_to_ET_varnames</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">var_ET</span> <span class="o">+=</span> <span class="n">aurel_to_ET_varnames</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">var_ET</span> <span class="o">+=</span> <span class="p">[</span><span class="n">v</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">var_ET</span></div>


<div class="viewcode-block" id="transform_vars_ET_to_aurel_groups">
<a class="viewcode-back" href="../../source/reading.html#aurel.reading.transform_vars_ET_to_aurel_groups">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">transform_vars_ET_to_aurel_groups</span><span class="p">(</span><span class="nb">vars</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transform ET variable names to Aurel variable group names.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    var : list of str</span>
<span class="sd">        List of variable names to transform.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of str</span>
<span class="sd">        List of transformed variable names.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">aurel_vars</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">newv</span><span class="p">,</span> <span class="n">oldvs</span> <span class="ow">in</span>  <span class="n">aurel_to_ET_varnames</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">vars</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">oldvs</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">oldvs</span><span class="p">):</span>
            <span class="n">aurel_vars</span> <span class="o">+=</span> <span class="p">[</span><span class="n">newv</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">oldv</span> <span class="ow">in</span> <span class="n">oldvs</span><span class="p">:</span>
                <span class="nb">vars</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">oldv</span><span class="p">)</span>
    <span class="n">aurel_vars</span> <span class="o">+=</span> <span class="nb">vars</span>
    <span class="k">return</span> <span class="n">aurel_vars</span></div>


<span class="n">ET_to_aurel_varnames</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;rho&#39;</span><span class="p">:</span><span class="s1">&#39;rho0&#39;</span><span class="p">,</span> <span class="s1">&#39;alp&#39;</span><span class="p">:</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;dtalp&#39;</span><span class="p">:</span><span class="s1">&#39;dtalpha&#39;</span><span class="p">,</span>
    <span class="s1">&#39;trK&#39;</span><span class="p">:</span><span class="s1">&#39;Ktrace&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span><span class="s1">&#39;Hamiltonian&#39;</span><span class="p">,</span>
    <span class="s1">&#39;vel[0]&#39;</span><span class="p">:</span><span class="s1">&#39;velx&#39;</span><span class="p">,</span> <span class="s1">&#39;vel[1]&#39;</span><span class="p">:</span><span class="s1">&#39;vely&#39;</span><span class="p">,</span> <span class="s1">&#39;vel[2]&#39;</span><span class="p">:</span><span class="s1">&#39;velz&#39;</span><span class="p">,</span>
    <span class="s1">&#39;M1&#39;</span><span class="p">:</span><span class="s1">&#39;Momentumx&#39;</span><span class="p">,</span> <span class="s1">&#39;M2&#39;</span><span class="p">:</span><span class="s1">&#39;Momentumy&#39;</span><span class="p">,</span> <span class="s1">&#39;M3&#39;</span><span class="p">:</span><span class="s1">&#39;Momentumz&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Psi4r&#39;</span><span class="p">:</span><span class="s1">&#39;Weyl_Psi4r&#39;</span><span class="p">,</span> <span class="s1">&#39;Psi4i&#39;</span><span class="p">:</span><span class="s1">&#39;Weyl_Psi4i&#39;</span>
<span class="p">}</span>
<div class="viewcode-block" id="transform_vars_ET_to_aurel">
<a class="viewcode-back" href="../../source/reading.html#aurel.reading.transform_vars_ET_to_aurel">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">transform_vars_ET_to_aurel</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transform ET variable name to Aurel variable name.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    var : str</span>
<span class="sd">        String of variable name to transform.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        String of transformed variable name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">ET_to_aurel_varnames</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">ET_to_aurel_varnames</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">var</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1">#                Reading data file names and hdf5 dataset keys</span>
<span class="c1"># =============================================================================</span>

<span class="c1"># Regex for HDF5 dataset keys</span>
<span class="c1"># Example: &quot;ADMBASE::gxx it=0 tl=0 m=0 rl=0 c=0&quot;</span>
<span class="n">rx_key</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="sa">r</span><span class="s2">&quot;([^:]+)::(\S+) it=(\d+) tl=(\d+)( m=0)?( rl=(\d+))?( c=(\d+))?&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="parse_hdf5_key">
<a class="viewcode-back" href="../../source/reading.html#aurel.reading.parse_hdf5_key">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">parse_hdf5_key</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse HDF5 dataset key into its components.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    key : str</span>
<span class="sd">        HDF5 dataset key in format like &quot;admbase::gxx it=0 tl=0 m=0 rl=0 c=0&quot;</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict or None</span>
<span class="sd">        Returns None if the key doesn&#39;t match the expected format.</span>
<span class="sd">        Otherwise returns dictionary with parsed components::</span>

<span class="sd">            {</span>
<span class="sd">                &#39;thorn&#39;: str,        # e.g., &#39;admbase&#39;</span>
<span class="sd">                &#39;variable&#39;: str,     # e.g., &#39;gxx&#39;</span>
<span class="sd">                &#39;it&#39;: int,          # iteration number</span>
<span class="sd">                &#39;tl&#39;: int,          # time level</span>
<span class="sd">                &#39;m&#39;: int or None,   # m value (if present)</span>
<span class="sd">                &#39;rl&#39;: int or None,  # refinement level (if present) </span>
<span class="sd">                &#39;c&#39;: int or None    # chunk number (if present)</span>
<span class="sd">            }</span>
<span class="sd">            </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">match</span> <span class="o">=</span> <span class="n">rx_key</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;thorn&#39;</span><span class="p">:</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
            <span class="s1">&#39;variable&#39;</span><span class="p">:</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;it&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;tl&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span> <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;rl&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span> <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">9</span><span class="p">))</span> <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;combined variable name&#39;</span><span class="p">:</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;::&#39;</span> <span class="o">+</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="k">return</span> <span class="kc">None</span></div>


<span class="c1"># Regex for HDF5 filenames: matches both single-variable and group files</span>
<span class="c1"># Examples: &quot;rho.xyz.h5&quot;, &quot;admbase-metric.file_123.xyz.h5&quot;</span>
<span class="n">rx_h5file</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="sa">r</span><span class="s2">&quot;^(([a-zA-Z0-9_]+)-)?([a-zA-Z0-9\[\]_]+)(.xyz)?(.file_(\d+))?(.xyz)?.h5$&quot;</span><span class="p">)</span>

<span class="n">rx_checkpoint</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="sa">r</span><span class="s2">&quot;^checkpoint\.chkpt\.it_(\d+)(\.file_(\d+))?.h5$&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="parse_h5file">
<a class="viewcode-back" href="../../source/reading.html#aurel.reading.parse_h5file">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">parse_h5file</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse HDF5 filename into its components.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filepath : str</span>
<span class="sd">        HDF5 file path or filename. Can be either:</span>

<span class="sd">        - Full absolute/relative path: &quot;/path/to/admbase-metric.h5&quot;</span>
<span class="sd">        </span>
<span class="sd">        - Just filename: &quot;rho.xyz.h5&quot;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict or None</span>
<span class="sd">        Returns None if the filename doesn&#39;t match the expected format.</span>
<span class="sd">        Otherwise returns dictionary with parsed components::</span>

<span class="sd">            {</span>
<span class="sd">                &#39;thorn_group&#39;: str or None, # e.g., &#39;admbase-&#39; or None</span>
<span class="sd">                &#39;thorn&#39;: str or None,       # e.g., &#39;admbase&#39; or None  </span>
<span class="sd">                &#39;variable_or_group&#39;: str,   # e.g., &#39;metric&#39; or &#39;rho&#39;</span>
<span class="sd">                &#39;xyz_prefix&#39;: str or None,  # e.g., &#39;.xyz&#39; or None</span>
<span class="sd">                &#39;chunk_number&#39;: int or None # e.g., 123 or None (from file_nbr)</span>
<span class="sd">                &#39;xyz_suffix&#39;: str or None,  # e.g., &#39;.xyz&#39; or None</span>
<span class="sd">                &#39;is_group_file&#39;: bool,      # True -&gt; a grouped variable file</span>
<span class="sd">            }</span>

<span class="sd">        And if it is a checkpoint file::</span>

<span class="sd">            {</span>
<span class="sd">                &#39;iteration&#39;: int,        # e.g., 1000</span>
<span class="sd">                &#39;chunk_number&#39;: int or None # e.g., 123 or None (from file_nbr)</span>
<span class="sd">            }</span>

<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Extract just the filename if a full path was provided</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span> <span class="ow">in</span> <span class="n">filepath</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">filepath</span>
    
    <span class="n">match_checkpoint</span> <span class="o">=</span> <span class="n">rx_checkpoint</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">rx_h5file</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">match_checkpoint</span><span class="p">:</span>
        <span class="n">iteration</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">match_checkpoint</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                     <span class="k">if</span> <span class="n">match_checkpoint</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">chunk_number</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">match_checkpoint</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">match_checkpoint</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;iteration&#39;</span><span class="p">:</span> <span class="n">iteration</span><span class="p">,</span>
                <span class="s1">&#39;chunk_number&#39;</span><span class="p">:</span> <span class="n">chunk_number</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">match</span><span class="p">:</span>
        <span class="n">thorn_group_with_dash</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># e.g., &quot;admbase-&quot; or None</span>
        <span class="n">thorn_name</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>             <span class="c1"># e.g., &quot;admbase&quot; or None</span>
        <span class="n">variable_or_group_name</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="c1"># e.g., &quot;metric&quot; or &quot;rho&quot;</span>
        <span class="n">xyz_prefix</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>             <span class="c1"># e.g., &quot;.xyz&quot; or None</span>
        <span class="n">chunk_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span> <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
                                                <span class="c1"># e.g., &quot;123&quot; or None</span>
        <span class="n">xyz_suffix</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>             <span class="c1"># e.g., &quot;.xyz&quot; or None</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">thorn_group_with_dash</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> 
            <span class="ow">and</span> <span class="n">variable_or_group_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">base_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">thorn_group_with_dash</span><span class="si">}{</span><span class="n">variable_or_group_name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">base_name</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;thorn_with_dash&#39;</span><span class="p">:</span> <span class="n">thorn_group_with_dash</span><span class="p">,</span>
            <span class="s1">&#39;thorn&#39;</span><span class="p">:</span> <span class="n">thorn_name</span><span class="p">,</span>
            <span class="s1">&#39;variable_or_group&#39;</span><span class="p">:</span> <span class="n">variable_or_group_name</span><span class="p">,</span>
            <span class="s1">&#39;base_name&#39;</span><span class="p">:</span> <span class="n">base_name</span><span class="p">,</span>
            <span class="s1">&#39;xyz_prefix&#39;</span><span class="p">:</span> <span class="n">xyz_prefix</span><span class="p">,</span>
            <span class="s1">&#39;chunk_number&#39;</span><span class="p">:</span> <span class="n">chunk_number</span><span class="p">,</span>
            <span class="s1">&#39;xyz_suffix&#39;</span><span class="p">:</span> <span class="n">xyz_suffix</span><span class="p">,</span>
            <span class="s1">&#39;group_file&#39;</span><span class="p">:</span> <span class="n">thorn_group_with_dash</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">}</span>
    <span class="k">return</span> <span class="kc">None</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1">#           Reading parameters, iterations and list data content</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="parameters">
<a class="viewcode-back" href="../../source/reading.html#aurel.reading.parameters">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">parameters</span><span class="p">(</span><span class="n">simname</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read and parse Einstein Toolkit simulation parameters.</span>

<span class="sd">    Extracts comprehensive simulation metadata from Einstein Toolkit parameter</span>
<span class="sd">    files (.par), including grid configuration, restart information, and all</span>
<span class="sd">    thorn-specific parameters.</span>

<span class="sd">    The function automatically:</span>
<span class="sd">    - Locates parameter files</span>
<span class="sd">    - Counts restart files to determine simulation state</span>
<span class="sd">    - Calculates derived grid parameters (extents, grid points)</span>
<span class="sd">    - Parses thorn parameters with proper type conversion</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    simname : str</span>
<span class="sd">        Name of the simulation directory to analyze.</span>
<span class="sd">        Must exist in one of the SIMLOC directories.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Comprehensive parameter dictionary containing:</span>

<span class="sd">        Core Information:</span>
<span class="sd">            &#39;simname&#39; : str, Simulation name (input parameter)</span>

<span class="sd">            &#39;simulation&#39; : str, Data format identifier (&#39;ET&#39;)</span>

<span class="sd">            &#39;simpath&#39; : str, Path to simulation root directory</span>
<span class="sd">            </span>
<span class="sd">        Grid Parameters:</span>
<span class="sd">            &#39;xmin&#39;, &#39;xmax&#39;, &#39;Lx&#39;, &#39;Nx&#39;, &#39;dx&#39; : float/int, minimum, maximum, </span>
<span class="sd">            extent, grid points and spacing. Same for Y and Z-direction </span>
<span class="sd">            parameters.</span>
<span class="sd">            </span>
<span class="sd">        Thorn Information:</span>
<span class="sd">            &#39;list_of_thorns&#39; : list of str, All active thorns in the simulation</span>
<span class="sd">            </span>
<span class="sd">        Parameter Values:</span>
<span class="sd">            All parameters from the .par file with appropriate types.</span>
<span class="sd">            Conflicting parameter names include thorn prefix.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The SIMLOC environment variable must be set:</span>
<span class="sd">    </span>
<span class="sd">        ``export SIMLOC=&quot;/path/to/simulations&quot;``</span>
<span class="sd">        </span>
<span class="sd">    For multiple locations (use colon on Unix/Mac, semicolon on Windows):</span>
<span class="sd">    </span>
<span class="sd">        ``export SIMLOC=&quot;/path1:/path2:/path3&quot;``  # Unix/Mac</span>
<span class="sd">        </span>
<span class="sd">        ``set SIMLOC=&quot;C:\path1;C:\path2;C:\path3&quot;``  # Windows</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;simname&#39;</span><span class="p">:</span><span class="n">simname</span><span class="p">,</span>
        <span class="s1">&#39;simulation&#39;</span><span class="p">:</span><span class="s1">&#39;ET&#39;</span>
        <span class="p">}</span>

    <span class="c1"># Looking for data</span>
    <span class="n">founddata</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">simlocs</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SIMLOC&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">simlocs</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;Could not find environment variable SIMLOC. &#39;</span>
            <span class="o">+</span><span class="s1">&#39;Please set it to the path of your simulations.&#39;</span>
            <span class="o">+</span><span class="s1">&#39;`export SIMLOC=&quot;/path/to/simulations/&quot;`&#39;</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">simloc</span> <span class="ow">in</span> <span class="n">simlocs</span><span class="p">:</span>
        <span class="n">param_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">simloc</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;simname&#39;</span><span class="p">]</span> 
                                       <span class="o">+</span> <span class="s1">&#39;/output-*/&#39;</span> 
                                       <span class="o">+</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;simname&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.par&#39;</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">param_files</span><span class="p">:</span>
            <span class="n">parampath</span> <span class="o">=</span> <span class="n">param_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">founddata</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;simpath&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">simloc</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;datapath&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">simloc</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;simname&#39;</span><span class="p">]</span> 
                                      <span class="o">+</span> <span class="s1">&#39;/output-0000/&#39;</span>
                                      <span class="o">+</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;simname&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
            <span class="k">break</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">founddata</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Could not find simulation parameter file for: &#39;</span> 
                         <span class="o">+</span> <span class="n">simname</span><span class="p">)</span>

    <span class="c1"># save all parameters</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">parampath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1"># read file</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span> <span class="c1"># remove comments</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="n">l</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="c1"># remove empty lines</span>

    <span class="n">list_of_thorns</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;::&#39;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="s1">&#39;=&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="c1"># split line into thorn, variable and value</span>
            <span class="c1"># thorn::variable=value</span>
            <span class="c1"># split thorn and rest of line</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;::&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
            <span class="n">thorn</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">linerest</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">:]:</span>
                    <span class="n">linerest</span> <span class="o">+=</span> <span class="s1">&#39;::&#39;</span> <span class="o">+</span> <span class="n">l</span>
            <span class="c1"># split rest of line into variable and value</span>
            <span class="c1"># TODO: case where value goes across multiple lines</span>
            <span class="n">linerest</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">linerest</span><span class="p">)</span>
            <span class="n">variable</span> <span class="o">=</span> <span class="n">linerest</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">linerest</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">linerest</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">linerest</span><span class="p">[</span><span class="mi">2</span><span class="p">:]:</span>
                    <span class="n">value</span> <span class="o">+=</span> <span class="s1">&#39;=&#39;</span><span class="o">+</span><span class="n">l</span>
            <span class="n">thorn</span> <span class="o">=</span> <span class="n">thorn</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">variable</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            
            <span class="c1"># format value, number or string</span>
            <span class="n">digitvalue</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">digitvalue</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">value</span> <span class="ow">or</span> <span class="s1">&#39;e&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;&quot;&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    
            <span class="c1"># save variable and value</span>
            <span class="k">if</span> <span class="n">variable</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s1">&#39;verbose&#39;</span><span class="p">,</span>
                <span class="s1">&#39;timelevels&#39;</span><span class="p">,</span>
                <span class="s1">&#39;evolution_method&#39;</span><span class="p">,</span>
                <span class="s1">&#39;out_every&#39;</span><span class="p">,</span> 
                <span class="s1">&#39;one_file_per_group&#39;</span><span class="p">]:</span>
                <span class="c1"># different thorns use the same variable name</span>
                <span class="n">parameters</span><span class="p">[</span><span class="n">thorn</span> <span class="o">+</span> <span class="s1">&#39;::&#39;</span> <span class="o">+</span> <span class="n">variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parameters</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

            <span class="c1"># save thorn name</span>
            <span class="n">list_of_thorns</span> <span class="o">+=</span> <span class="p">[</span><span class="n">thorn</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;ActiveThorns&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">thorns</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">list_of_thorns</span> <span class="o">+=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">thorns</span><span class="p">)</span>
    <span class="n">list_of_thorns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">list_of_thorns</span><span class="p">))</span> <span class="c1"># remove duplicates</span>
    <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;list_of_thorns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">list_of_thorns</span>
                
    <span class="c1"># calculate extra grid info</span>
    <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">]:</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="n">coord</span><span class="o">+</span><span class="s1">&#39;max&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">parameters</span><span class="p">[</span><span class="n">coord</span><span class="o">+</span><span class="s1">&#39;min&#39;</span><span class="p">]</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">L</span><span class="o">/</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="o">+</span><span class="n">coord</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span> <span class="c1"># default not include lower point</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;boundary_shiftout_&#39;</span><span class="o">+</span><span class="n">coord</span><span class="o">+</span><span class="s1">&#39;_lower&#39;</span><span class="p">,</span> 
                       <span class="s1">&#39;boundary_shiftout_&#39;</span><span class="o">+</span><span class="n">coord</span><span class="o">+</span><span class="s1">&#39;_upper&#39;</span><span class="p">]:</span>
                <span class="n">N</span> <span class="o">+=</span> <span class="n">parameters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;boundary_shiftout_&#39;</span><span class="o">+</span><span class="n">coord</span><span class="o">+</span><span class="s1">&#39;_lower&#39;</span> 
            <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
            <span class="n">parameters</span><span class="p">[</span><span class="n">coord</span><span class="o">+</span><span class="s1">&#39;min&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="o">+</span><span class="n">coord</span><span class="p">]</span>
        <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="o">+</span><span class="n">coord</span><span class="p">]</span> <span class="o">=</span> <span class="n">L</span>
        <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="o">+</span><span class="n">coord</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span>
    <span class="k">if</span> <span class="s1">&#39;max_refinement_levels&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;max_refinement_levels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">parameters</span></div>


<div class="viewcode-block" id="saveprint">
<a class="viewcode-back" href="../../source/reading.html#aurel.reading.saveprint">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">saveprint</span><span class="p">(</span><span class="n">it_file</span><span class="p">,</span> <span class="n">some_str</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Save the string to the file and print it to the screen.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">some_str</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">redirect_stdout</span><span class="p">(</span><span class="n">it_file</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">some_str</span><span class="p">)</span></div>


<div class="viewcode-block" id="iterations">
<a class="viewcode-back" href="../../source/reading.html#aurel.reading.iterations">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">iterations</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Analyze and catalog available iterations across all simulation restarts.</span>

<span class="sd">    This function systematically scans Einstein Toolkit simulation output</span>
<span class="sd">    to determine what data is available at each iteration and refinement level</span>
<span class="sd">    across all restart files. It creates a comprehensive catalog saved to</span>
<span class="sd">    simpath/simname/iterations.txt for quick access by other analysis </span>
<span class="sd">    functions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    param : dict</span>
<span class="sd">        Simulation parameters from `parameters()` function. Must contain:</span>

<span class="sd">        - &#39;simpath&#39;: Path to simulation directory (with trailing slash)</span>
<span class="sd">        - &#39;simname&#39;: Simulation name</span>
<span class="sd">        </span>
<span class="sd">    skip_last : bool, optional</span>
<span class="sd">        Skip the last restart directory. Default True.</span>
<span class="sd">        Useful to avoid interrupting running simulations.</span>
<span class="sd">        </span>
<span class="sd">    verbose : bool, optional</span>
<span class="sd">        Print detailed progress information. Default True.</span>
<span class="sd">        Shows contents of iterations.txt file and overall summary.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Dictionary containing iteration information for all restarts::</span>
<span class="sd">        </span>
<span class="sd">            {</span>
<span class="sd">                restart_number: {</span>
<span class="sd">                    &#39;var available&#39;: [variable names],</span>
<span class="sd">                    &#39;its available&#39;: [itmin, itmax], </span>
<span class="sd">                    &#39;rl = 0&#39;: [itmin, itmax, dit],</span>
<span class="sd">                    &#39;rl = 1&#39;: [itmin, itmax, dit],</span>
<span class="sd">                    ...</span>
<span class="sd">                    &#39;checkpoints&#39;: [it1, it2, ...]</span>
<span class="sd">                },</span>
<span class="sd">                ...</span>
<span class="sd">                &#39;overall&#39;: {</span>
<span class="sd">                    &#39;rl = 0&#39;: [[itmin, itmax, dit], ...],</span>
<span class="sd">                    &#39;rl = 1&#39;: [[itmin, itmax, dit], ...],</span>
<span class="sd">                    ...</span>
<span class="sd">                }</span>
<span class="sd">            }</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Creates/appends to &#39;{simpath}/{simname}/iterations.txt&#39; with format::</span>
<span class="sd">    </span>
<span class="sd">        === restart 0</span>
<span class="sd">        3D variables available: [&#39;rho&#39;, &#39;alpha&#39;, &#39;gxx&#39;, ...]</span>
<span class="sd">        it = 0 -&gt; 1000</span>
<span class="sd">        rl = 0 at it = np.arange(0, 1000, 2)</span>
<span class="sd">        rl = 1 at it = np.arange(0, 1000, 1)</span>
<span class="sd">        Checkpoints available at its: [0, 10, ...]</span>
<span class="sd">        === restart 1</span>
<span class="sd">        ...</span>

<span class="sd">    Also with verbose=True, prints the above and overall iterations from </span>
<span class="sd">    collect_overall_iterations ::</span>

<span class="sd">        === Overall iterations</span>
<span class="sd">        rl = 0 at it = [np.arange(0, 2000, 2)]</span>
<span class="sd">        rl = 1 at it = [np.arange(0, 2000, 1)]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">skip_last</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;skip_last&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;verbose&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">verbose_file</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;verbose_file&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Open/create iterations catalog file</span>
    <span class="n">it_filename</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;simpath&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;simname&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/iterations.txt&#39;</span>
    <span class="n">file_existed_before</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">it_filename</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="n">verbose_file</span><span class="p">:</span>
        <span class="n">verbose_file</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_existed_before</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Creating new iterations file: &#39;</span> <span class="o">+</span> <span class="n">it_filename</span><span class="p">,</span> 
                  <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">it_filename</span><span class="p">,</span> <span class="s2">&quot;a+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">it_file</span><span class="p">:</span>
        <span class="c1"># Display existing content from previous runs</span>
        <span class="n">it_file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">it_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="c1"># Create its_available dictionary to store iteration data</span>
        <span class="k">if</span> <span class="n">file_existed_before</span><span class="p">:</span>
            <span class="n">its_available</span> <span class="o">=</span> <span class="n">read_iterations</span><span class="p">(</span>
                <span class="n">param</span><span class="p">,</span> <span class="n">skip_last</span><span class="o">=</span><span class="n">skip_last</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">its_available</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Print existing contents if verbose_file</span>
        <span class="k">if</span> <span class="n">verbose_file</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Determine all restarts available</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;simpath&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;simname&#39;</span><span class="p">])</span>
        <span class="n">output_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^output-(\d+)$&#39;</span><span class="p">)</span>
        <span class="n">relevant_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">file</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span> 
                          <span class="k">if</span> <span class="n">output_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">file</span><span class="p">)]</span>
        <span class="n">all_restarts</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">fl</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> 
                                <span class="k">for</span> <span class="n">fl</span> <span class="ow">in</span> <span class="n">relevant_files</span><span class="p">])</span>

        <span class="c1"># Determine which restarts need processing</span>
        <span class="c1"># Cut off the active one</span>
        <span class="k">if</span> <span class="n">skip_last</span><span class="p">:</span>
            <span class="n">all_restarts</span> <span class="o">=</span> <span class="n">all_restarts</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Cut off what has already been processed</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">contents</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">restarts_done</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;restart &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> 
                         <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span> 
                         <span class="k">if</span> <span class="s1">&#39;restart&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">]</span>
        <span class="n">all_restarts</span> <span class="o">=</span> <span class="p">[</span><span class="n">rnbr</span> <span class="k">for</span> <span class="n">rnbr</span> <span class="ow">in</span> <span class="n">all_restarts</span> 
                        <span class="k">if</span> <span class="n">rnbr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">restarts_done</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">all_restarts</span> <span class="o">==</span> <span class="p">[]</span> <span class="ow">and</span> <span class="n">restarts_done</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="k">if</span> <span class="n">skip_last</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                    <span class="s1">&#39;Nothing to process. Consider running with&#39;</span>
                    <span class="o">+</span> <span class="s1">&#39; skip_last=False to analyse the last restart&#39;</span>
                    <span class="o">+</span> <span class="s1">&#39; (if it is not an active restart).&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s1">&#39;Nothing to process.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Restarts to process: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">all_restarts</span><span class="p">),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">all_restarts</span> <span class="o">==</span> <span class="p">[]</span> <span class="ow">and</span> <span class="n">skip_last</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Nothing new to process. Consider running with&#39;</span>
                      <span class="o">+</span> <span class="s1">&#39; skip_last=False to analyse the last restart&#39;</span>
                      <span class="o">+</span> <span class="s1">&#39; (if it is not an active restart).&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Process each restart directory</span>
        <span class="k">for</span> <span class="n">restart</span> <span class="ow">in</span> <span class="n">all_restarts</span><span class="p">:</span>
            <span class="n">saveprint</span><span class="p">(</span><span class="n">it_file</span><span class="p">,</span> <span class="s1">&#39; === restart </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">restart</span><span class="p">),</span> 
                      <span class="n">verbose</span><span class="o">=</span><span class="n">verbose_file</span><span class="p">)</span>
            <span class="n">its_available</span><span class="p">[</span><span class="n">restart</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            
            <span class="c1"># Analyze available variables in this restart</span>
            <span class="n">vars_and_files</span> <span class="o">=</span> <span class="n">get_content</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> 
                                         <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">restart</span><span class="o">=</span><span class="n">restart</span><span class="p">)</span>
            <span class="n">vars_available</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">vars_and_files</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">vars_available</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            
            <span class="c1"># Error handling for empty restart directories</span>
            <span class="k">if</span> <span class="n">vars_available</span> <span class="o">==</span> <span class="p">[]:</span>
                <span class="c1"># Path to this restart&#39;s output directory that was checked</span>
                <span class="n">datapath</span> <span class="o">=</span> <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;simpath&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;simname&#39;</span><span class="p">]</span>
                            <span class="o">+</span><span class="s1">&#39;/output-</span><span class="si">{:04d}</span><span class="s1">/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">restart</span><span class="p">)</span>
                            <span class="o">+</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;simname&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
                <span class="n">saveprint</span><span class="p">(</span><span class="n">it_file</span><span class="p">,</span> <span class="s1">&#39;Could not find 3D data in &#39;</span> <span class="o">+</span> <span class="n">datapath</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Transform ET variable names to Aurel conventions</span>
                <span class="n">aurel_vars_available</span> <span class="o">=</span> <span class="n">transform_vars_ET_to_aurel_groups</span><span class="p">(</span>
                    <span class="n">vars_available</span><span class="p">)</span>
                <span class="n">saveprint</span><span class="p">(</span><span class="n">it_file</span><span class="p">,</span> <span class="s1">&#39;3D variables available: &#39;</span>
                          <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">aurel_vars_available</span><span class="p">),</span> 
                          <span class="n">verbose</span><span class="o">=</span><span class="n">verbose_file</span><span class="p">)</span>
                <span class="n">its_available</span><span class="p">[</span><span class="n">restart</span><span class="p">][</span><span class="s1">&#39;var available&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aurel_vars_available</span>
                
                <span class="c1"># Select representative file for iteration analysis</span>
                <span class="c1"># Preferably a light file that only has one variable</span>
                <span class="n">files_with_single_var</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">var</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">vars_and_files</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> 
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">var</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">files_with_single_var</span> <span class="o">==</span> <span class="p">[]:</span>
                    <span class="k">for</span> <span class="n">var_to_read</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">vars_and_files</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="n">file_for_it</span> <span class="o">=</span> <span class="n">vars_and_files</span><span class="p">[</span><span class="n">var_to_read</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Checking if &#39;</span> <span class="o">+</span> <span class="n">file_for_it</span>
                                      <span class="o">+</span> <span class="s1">&#39; can be read&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">file_for_it</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                                <span class="n">fkeys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                            <span class="n">file_to_read</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>
                        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR: Could not read &#39;</span> 
                                      <span class="o">+</span> <span class="n">file_for_it</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="n">file_to_read</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">var_to_read</span> <span class="ow">in</span> <span class="n">files_with_single_var</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;NaNmask&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">var_to_read</span><span class="p">:</span>
                            <span class="n">file_for_it</span> <span class="o">=</span> <span class="n">vars_and_files</span><span class="p">[</span><span class="n">var_to_read</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Checking if &#39;</span> <span class="o">+</span> <span class="n">file_for_it</span>
                                        <span class="o">+</span> <span class="s1">&#39; can be read&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                                <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">file_for_it</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                                    <span class="n">fkeys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                                <span class="n">file_to_read</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">break</span>
                            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR: Could not read &#39;</span> 
                                        <span class="o">+</span> <span class="n">file_for_it</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                                <span class="n">file_to_read</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">continue</span>
                <span class="k">if</span> <span class="n">file_to_read</span><span class="p">:</span>
                    <span class="n">saveprint</span><span class="p">(</span><span class="n">it_file</span><span class="p">,</span> <span class="s1">&#39;Reading iterations in: &#39;</span>
                            <span class="o">+</span> <span class="n">file_for_it</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose_file</span><span class="p">)</span>
                    <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">file_for_it</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        
                        <span class="c1"># only consider one of the variables in this file</span>
                        <span class="n">fkeys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                        <span class="k">for</span> <span class="n">fk</span> <span class="ow">in</span> <span class="n">fkeys</span><span class="p">:</span>
                            <span class="n">varkey</span> <span class="o">=</span> <span class="n">parse_hdf5_key</span><span class="p">(</span><span class="n">fk</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">varkey</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">varkey</span> <span class="o">=</span> <span class="n">varkey</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span>
                                <span class="k">break</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Checking variable </span><span class="si">{</span><span class="n">varkey</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                            
                        <span class="c1"># all the keys of this variable</span>
                        <span class="n">fkeys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">fkeys</span> <span class="k">if</span> <span class="n">varkey</span> <span class="ow">in</span> <span class="n">k</span><span class="p">]</span>
                        
                        <span class="c1"># all the iterations</span>
                        <span class="n">allits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">([</span><span class="n">parse_hdf5_key</span><span class="p">(</span><span class="n">k</span><span class="p">)[</span><span class="s1">&#39;it&#39;</span><span class="p">]</span> 
                                          <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">fkeys</span><span class="p">])</span>
                        <span class="n">saveprint</span><span class="p">(</span>
                            <span class="n">it_file</span><span class="p">,</span> 
                            <span class="s1">&#39;it = </span><span class="si">{}</span><span class="s1"> -&gt; </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">allits</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">allits</span><span class="p">)),</span> 
                            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose_file</span><span class="p">)</span>
                        <span class="n">its_available</span><span class="p">[</span><span class="n">restart</span><span class="p">][</span><span class="s1">&#39;its available&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">allits</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">allits</span><span class="p">)]</span>
                            
                        <span class="c1"># maximum refinement level present</span>
                        <span class="n">rlmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">parse_hdf5_key</span><span class="p">(</span><span class="n">k</span><span class="p">)[</span><span class="s1">&#39;rl&#39;</span><span class="p">]</span> 
                                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">fkeys</span><span class="p">])</span>
                        
                        <span class="c1"># for each refinement level</span>
                        <span class="k">for</span> <span class="n">rl</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rlmax</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                            <span class="c1"># take the corresponding keys</span>
                            <span class="n">keysrl</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">fkeys</span> 
                                    <span class="k">if</span> <span class="n">parse_hdf5_key</span><span class="p">(</span><span class="n">k</span><span class="p">)[</span><span class="s1">&#39;rl&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">rl</span><span class="p">]</span>
        
                            <span class="k">if</span> <span class="n">keysrl</span><span class="o">!=</span><span class="p">[]:</span>
                                <span class="c1"># Check if there are chunk numbers</span>
                                <span class="k">if</span> <span class="n">parse_hdf5_key</span><span class="p">(</span><span class="n">keysrl</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">cs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">parse_hdf5_key</span><span class="p">(</span><span class="n">k</span><span class="p">)[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span> 
                                                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keysrl</span><span class="p">]))</span>
                                    <span class="n">chosen_c</span> <span class="o">=</span> <span class="s1">&#39; c=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">cs</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">chosen_c</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                                <span class="n">keysrl</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keysrl</span> <span class="k">if</span> <span class="n">chosen_c</span> <span class="ow">in</span> <span class="n">k</span><span class="p">]</span>
                                
                                <span class="c1"># and look at what iterations they have</span>
                                <span class="n">allits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">([</span><span class="n">parse_hdf5_key</span><span class="p">(</span><span class="n">k</span><span class="p">)[</span><span class="s1">&#39;it&#39;</span><span class="p">]</span> 
                                                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keysrl</span><span class="p">])</span>

                                <span class="n">rlkey</span> <span class="o">=</span> <span class="s1">&#39;rl = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rl</span><span class="p">)</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">allits</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                                    <span class="n">itkey</span> <span class="o">=</span> <span class="s1">&#39;it = np.arange(</span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">allits</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">allits</span><span class="p">),</span> 
                                        <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">allits</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                                    <span class="n">its_available</span><span class="p">[</span><span class="n">restart</span><span class="p">][</span><span class="n">rlkey</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">allits</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">allits</span><span class="p">),</span> 
                                        <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">allits</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">itkey</span> <span class="o">=</span> <span class="s1">&#39;it = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">allits</span><span class="p">)</span>
                                    <span class="n">its_available</span><span class="p">[</span><span class="n">restart</span><span class="p">][</span><span class="n">rlkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">allits</span>
                                <span class="n">saveprint</span><span class="p">(</span><span class="n">it_file</span><span class="p">,</span> <span class="n">rlkey</span><span class="o">+</span><span class="s1">&#39; at &#39;</span><span class="o">+</span><span class="n">itkey</span><span class="p">,</span> 
                                        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose_file</span><span class="p">)</span>
            
            <span class="c1"># List checkpoints available</span>
            <span class="n">checkpoint_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span>
                <span class="n">param</span><span class="p">[</span><span class="s1">&#39;simpath&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;simname&#39;</span><span class="p">]</span>
                <span class="o">+</span> <span class="s1">&#39;/output-</span><span class="si">{:04d}</span><span class="s1">/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">restart</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;simname&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/checkpoint.chkpt.it_*.h5&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">checkpoint_files</span> <span class="o">!=</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="s1">&#39;.file_&#39;</span> <span class="ow">in</span> <span class="n">checkpoint_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">checkpoint_files</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">cf</span> <span class="k">for</span> <span class="n">cf</span> <span class="ow">in</span> <span class="n">checkpoint_files</span> <span class="k">if</span> <span class="s1">&#39;.file_0.&#39;</span> <span class="ow">in</span> <span class="n">cf</span><span class="p">]</span>
                
            <span class="n">checkpoint_its</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">chkfile</span> <span class="ow">in</span> <span class="n">checkpoint_files</span><span class="p">:</span>
                <span class="n">chk_it</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">chkfile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;checkpoint.chkpt.it_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">checkpoint_its</span> <span class="o">+=</span> <span class="p">[</span><span class="n">chk_it</span><span class="p">]</span>
            <span class="n">checkpoint_its</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">checkpoint_its</span><span class="p">)))</span>

            <span class="k">if</span> <span class="s1">&#39;its available&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">its_available</span><span class="p">[</span><span class="n">restart</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">its_available</span><span class="p">[</span><span class="n">restart</span><span class="p">][</span><span class="s1">&#39;its available&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">checkpoint_its</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">checkpoint_its</span><span class="p">)]</span>
                <span class="n">saveprint</span><span class="p">(</span><span class="n">it_file</span><span class="p">,</span> <span class="s1">&#39;it = </span><span class="si">{}</span><span class="s1"> -&gt; </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">checkpoint_its</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">checkpoint_its</span><span class="p">)),</span> 
                    <span class="n">verbose</span><span class="o">=</span><span class="n">verbose_file</span><span class="p">)</span>

            <span class="n">its_available</span><span class="p">[</span><span class="n">restart</span><span class="p">][</span><span class="s1">&#39;checkpoints&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">checkpoint_its</span>
            <span class="n">saveprint</span><span class="p">(</span><span class="n">it_file</span><span class="p">,</span> 
                      <span class="s1">&#39;Checkpoints available at its: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                          <span class="nb">list</span><span class="p">(</span><span class="n">checkpoint_its</span><span class="p">)),</span>
                          <span class="n">verbose</span><span class="o">=</span><span class="n">verbose_file</span><span class="p">)</span>
        <span class="c1"># Overall iterations</span>
        <span class="n">its_available</span> <span class="o">=</span> <span class="n">collect_overall_iterations</span><span class="p">(</span><span class="n">its_available</span><span class="p">,</span> <span class="n">verbose_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">its_available</span></div>


<div class="viewcode-block" id="read_iterations">
<a class="viewcode-back" href="../../source/reading.html#aurel.reading.read_iterations">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">read_iterations</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read and parse the iterations.txt file to extract iteration information.</span>

<span class="sd">    This is a helper function for `iterations()`.</span>

<span class="sd">    This function loads the iterations catalog created by `iterations()` and</span>
<span class="sd">    parses it into a structured dictionary format for programmatic access.</span>
<span class="sd">    If the iterations.txt file doesn&#39;t exist, then the `iterations()` function</span>
<span class="sd">    is called instead.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    param : dict</span>
<span class="sd">        Simulation parameters from `parameters()` function. Must contain:</span>

<span class="sd">        - &#39;simpath&#39;: Path to simulation directory</span>
<span class="sd">        - &#39;simname&#39;: Simulation name</span>
<span class="sd">        </span>
<span class="sd">    skip_last : bool, optional</span>
<span class="sd">        Skip the last restart directory when creating iterations.txt.</span>
<span class="sd">        Default True. This is passed to `iterations()`.</span>
<span class="sd">        </span>
<span class="sd">    verbose : bool, optional</span>
<span class="sd">        Print detailed parsing information. Default False. </span>
<span class="sd">        Also passed to `iterations()`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Dictionary containing iteration information for all restarts::</span>
<span class="sd">        </span>
<span class="sd">            {</span>
<span class="sd">                restart_number: {</span>
<span class="sd">                    &#39;var available&#39;: [variable names],</span>
<span class="sd">                    &#39;its available&#39;: [itmin, itmax], </span>
<span class="sd">                    &#39;rl = 0&#39;: [itmin, itmax, dit],</span>
<span class="sd">                    &#39;rl = 1&#39;: [itmin, itmax, dit],</span>
<span class="sd">                    ...</span>
<span class="sd">                    &#39;checkpoints&#39;: [it1, it2, ...]</span>
<span class="sd">                },</span>
<span class="sd">                ...</span>
<span class="sd">            }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">skip_last</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;skip_last&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;verbose&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="n">it_filename</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;simpath&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;simname&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/iterations.txt&#39;</span>
    <span class="n">file_existed_before</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">it_filename</span><span class="p">)</span>

    <span class="c1"># if file does not exist, create it</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">file_existed_before</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">iterations</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">skip_last</span><span class="o">=</span><span class="n">skip_last</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># read the file</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Reading iterations in </span><span class="si">{</span><span class="n">it_filename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">it_filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">it_file</span><span class="p">:</span>
            <span class="n">it_file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="n">it_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="c1"># Empty file handling</span>
        <span class="k">if</span> <span class="n">contents</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;File is empty&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">contents</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># each line is a dictionary entry</span>
            <span class="n">its_available</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="c1"># higher level key is the restart number</span>
                <span class="k">if</span> <span class="s1">&#39; === restart &#39;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                    <span class="n">restart_nbr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; === restart &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">its_available</span><span class="p">[</span><span class="n">restart_nbr</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="c1"># lower level keys</span>
                <span class="c1"># variables available</span>
                <span class="k">elif</span> <span class="s1">&#39;3D variables available&#39;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                    <span class="nb">vars</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;3D variables available: [&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>
                    <span class="nb">vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">]</span>
                    <span class="n">its_available</span><span class="p">[</span><span class="n">restart_nbr</span><span class="p">][</span><span class="s1">&#39;var available&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">vars</span>
                <span class="c1"># iterations available (inclusive interval)</span>
                <span class="k">elif</span> <span class="s1">&#39;-&gt;&#39;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                    <span class="n">its_available</span><span class="p">[</span><span class="n">restart_nbr</span><span class="p">][</span><span class="s1">&#39;its available&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">4</span><span class="p">])]</span>
                <span class="c1"># iterations available for said refinement level</span>
                <span class="k">elif</span> <span class="s1">&#39;rl = &#39;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                    <span class="n">rl</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;rl = &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">rlkey</span> <span class="o">=</span> <span class="s1">&#39;rl = &#39;</span> <span class="o">+</span> <span class="n">rl</span>
                    <span class="k">if</span> <span class="s1">&#39;arange&#39;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                        <span class="n">it_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span> 
                                   <span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span> 
                                   <span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])]</span>
                        <span class="n">its_available</span><span class="p">[</span><span class="n">restart_nbr</span><span class="p">][</span><span class="n">rlkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">it_list</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">it_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])]</span>
                        <span class="n">its_available</span><span class="p">[</span><span class="n">restart_nbr</span><span class="p">][</span><span class="n">rlkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">it_list</span>
                
                <span class="k">elif</span> <span class="s1">&#39;Checkpoints available at its&#39;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                    <span class="n">chk_its</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;Checkpoints available at its: &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">chk_its</span> <span class="o">=</span> <span class="n">chk_its</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">chk_its</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                        <span class="n">its_available</span><span class="p">[</span><span class="n">restart_nbr</span><span class="p">][</span><span class="s1">&#39;checkpoints&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">chk_its</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">chk_its</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
                        <span class="n">its_available</span><span class="p">[</span><span class="n">restart_nbr</span><span class="p">][</span><span class="s1">&#39;checkpoints&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chk_its</span>

            <span class="k">return</span> <span class="n">its_available</span></div>


<div class="viewcode-block" id="collect_overall_iterations">
<a class="viewcode-back" href="../../source/reading.html#aurel.reading.collect_overall_iterations">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">collect_overall_iterations</span><span class="p">(</span><span class="n">its_available</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Merge iteration data across all restarts into overall summary.</span>

<span class="sd">    This is a helper function for `iterations()`.</span>
<span class="sd">    </span>
<span class="sd">    This function analyzes the iteration information from individual restart</span>
<span class="sd">    and merges them into a comprehensive overview of what iterations are </span>
<span class="sd">    available across the entire simulation. It handles multiple refinement </span>
<span class="sd">    levels and various iteration patterns: overlapping iteration ranges, </span>
<span class="sd">    different time stepping patterns, single iterations. These are merged when</span>
<span class="sd">    possible, otherwise they are kept as separate entries.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    its_available : dict</span>
<span class="sd">        Dictionary with iterations available for each restart, typically</span>
<span class="sd">        from `read_iterations()` or `iterations()`.</span>
<span class="sd">        </span>
<span class="sd">    verbose : bool</span>
<span class="sd">        If True, print the overall iterations summary to stdout.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        The input dictionary with an added &#39;overall&#39; key containing merged</span>
<span class="sd">        iteration information across all restarts::</span>
<span class="sd">        </span>
<span class="sd">            {</span>
<span class="sd">                restart_number: {...},  # Original restart data preserved</span>
<span class="sd">                &#39;overall&#39;: {</span>
<span class="sd">                    &#39;rl = 0&#39;: [[itmin, itmax, dit], ...],</span>
<span class="sd">                    &#39;rl = 1&#39;: [[itmin, itmax, dit], ...],</span>
<span class="sd">                    ...</span>
<span class="sd">                }</span>
<span class="sd">            }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Find maximum refinement level across all restarts</span>
    <span class="n">rlmax</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">restart</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">its_available</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">its_available</span><span class="p">[</span><span class="n">restart</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="s1">&#39;rl = &#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                <span class="n">rl</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;rl = &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">rl</span> <span class="o">&gt;</span> <span class="n">rlmax</span><span class="p">:</span>
                    <span class="n">rlmax</span> <span class="o">=</span> <span class="n">rl</span>

    <span class="c1"># First collect all the iterations, gradually merging them together</span>
    <span class="c1"># Start with base level then gradually increment to consider them all</span>
    <span class="n">rl</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">its_available</span><span class="p">[</span><span class="s1">&#39;overall&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; === Overall iterations&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">rl_to_do</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">while</span> <span class="n">rl_to_do</span><span class="p">:</span>
        <span class="n">it_situation</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rl_to_do</span> <span class="o">=</span> <span class="kc">False</span> 
        <span class="c1"># If current rl isn&#39;t found then while loop is broken</span>
        <span class="k">for</span> <span class="n">restart</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">its_available</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">rlkey</span> <span class="o">=</span> <span class="s1">&#39;rl = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rl</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rlkey</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">its_available</span><span class="p">[</span><span class="n">restart</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="c1"># rl found, so the while loop will be continued afterwards</span>
                <span class="n">rl_to_do</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">rl_it_situation</span> <span class="o">=</span> <span class="n">its_available</span><span class="p">[</span><span class="n">restart</span><span class="p">][</span><span class="n">rlkey</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">it_situation</span> <span class="o">==</span> <span class="p">[]:</span>
                    <span class="c1"># This is the first iteration segment found</span>
                    <span class="n">it_situation</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">rl_it_situation</span><span class="p">)]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">prev_rl_it_situation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">it_situation</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prev_rl_it_situation</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># Previous restart had an array</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rl_it_situation</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                            <span class="c1"># Current restart has an array</span>
                            <span class="k">if</span> <span class="n">prev_rl_it_situation</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">rl_it_situation</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                                <span class="c1"># They have the same dit so just update itmax</span>
                                <span class="n">it_situation</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rl_it_situation</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">it_situation</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">rl_it_situation</span><span class="p">)]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Current restart has just one iteration</span>
                            <span class="k">if</span> <span class="n">rl_it_situation</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                                <span class="n">prev_rl_it_situation</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
                                <span class="n">prev_rl_it_situation</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
                                <span class="n">prev_rl_it_situation</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                                <span class="k">pass</span>
                            <span class="k">elif</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">rl_it_situation</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                      <span class="o">-</span> <span class="n">prev_rl_it_situation</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                  <span class="o">==</span> <span class="n">prev_rl_it_situation</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                                <span class="n">it_situation</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">prev_rl_it_situation</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
                                                    <span class="n">rl_it_situation</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
                                                    <span class="n">prev_rl_it_situation</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">it_situation</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">rl_it_situation</span><span class="p">)]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Previous restart has just one iteration</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rl_it_situation</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                            <span class="c1"># Current restart has an array</span>
                            <span class="k">if</span> <span class="n">prev_rl_it_situation</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                                <span class="n">rl_it_situation</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
                                <span class="n">rl_it_situation</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
                                <span class="n">rl_it_situation</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                                <span class="n">it_situation</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">rl_it_situation</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">rl_it_situation</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
                                      <span class="o">-</span> <span class="n">prev_rl_it_situation</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> 
                                  <span class="o">==</span> <span class="n">rl_it_situation</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                                <span class="n">it_situation</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">prev_rl_it_situation</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
                                                    <span class="n">rl_it_situation</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
                                                    <span class="n">rl_it_situation</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">it_situation</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">rl_it_situation</span><span class="p">)]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Current restart has just one iteration</span>
                            <span class="k">if</span> <span class="n">prev_rl_it_situation</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">rl_it_situation</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                                <span class="k">pass</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">it_situation</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">rl_it_situation</span><span class="p">)]</span>
        
        <span class="k">if</span> <span class="n">rl_to_do</span><span class="p">:</span>
            <span class="n">its_available</span><span class="p">[</span><span class="s1">&#39;overall&#39;</span><span class="p">][</span><span class="n">rlkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">it_situation</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="c1"># Create a nice string to present them to the user</span>
                <span class="c1"># Start the string</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">it_situation</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">it_situation_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">it_situation_string</span> <span class="o">=</span> <span class="s1">&#39;[&#39;</span>
                <span class="c1"># Add each iteration segment</span>
                <span class="k">for</span> <span class="n">iit_situation</span> <span class="ow">in</span> <span class="n">it_situation</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">iit_situation</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># If it&#39;s an array, print np.arange</span>
                        <span class="n">it_situation_string</span> <span class="o">+=</span> <span class="s1">&#39;np.arange(</span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">iit_situation</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">iit_situation</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
                            <span class="n">iit_situation</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># If it&#39;s just one then give it directly</span>
                        <span class="n">it_situation_string</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iit_situation</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="c1"># End string or prepare for next segment</span>
                    <span class="k">if</span> <span class="n">iit_situation</span> <span class="o">==</span> <span class="n">it_situation</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">it_situation</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">it_situation_string</span> <span class="o">+=</span> <span class="s1">&#39;]&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">it_situation_string</span> <span class="o">+=</span> <span class="s1">&#39;, &#39;</span>
                
                <span class="c1"># Print overall iterations of said refinement level</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">rlkey</span><span class="p">,</span> <span class="s1">&#39;at it =&#39;</span><span class="p">,</span> <span class="n">it_situation_string</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">rl</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">rl</span> <span class="o">&gt;</span> <span class="n">rlmax</span><span class="p">:</span>
            <span class="n">rl_to_do</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rl_to_do</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">its_available</span></div>


<span class="n">known_groups</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;hydrobase-rho&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;rho&#39;</span><span class="p">],</span>
    <span class="s1">&#39;hydrobase-eps&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;eps&#39;</span><span class="p">],</span>
    <span class="s1">&#39;hydrobase-press&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;press&#39;</span><span class="p">],</span>
    <span class="s1">&#39;hydrobase-w_lorentz&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;w_lorentz&#39;</span><span class="p">],</span>
    <span class="s1">&#39;hydrobase-vel&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;vel[0]&#39;</span><span class="p">,</span> <span class="s1">&#39;vel[1]&#39;</span><span class="p">,</span> <span class="s1">&#39;vel[2]&#39;</span><span class="p">],</span>
    <span class="s1">&#39;admbase-lapse&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;alp&#39;</span><span class="p">],</span>
    <span class="s1">&#39;admbase-dtlapse&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;dtalp&#39;</span><span class="p">],</span>
    <span class="s1">&#39;admbase-shift&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;betax&#39;</span><span class="p">,</span> <span class="s1">&#39;betay&#39;</span><span class="p">,</span> <span class="s1">&#39;betaz&#39;</span><span class="p">],</span>
    <span class="s1">&#39;admbase-dtshift&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;dtbetax&#39;</span><span class="p">,</span> <span class="s1">&#39;dtbetay&#39;</span><span class="p">,</span> <span class="s1">&#39;dtbetaz&#39;</span><span class="p">],</span>
    <span class="s1">&#39;admbase-metric&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;gxx&#39;</span><span class="p">,</span> <span class="s1">&#39;gxy&#39;</span><span class="p">,</span> <span class="s1">&#39;gxz&#39;</span><span class="p">,</span> <span class="s1">&#39;gyy&#39;</span><span class="p">,</span> <span class="s1">&#39;gyz&#39;</span><span class="p">,</span> <span class="s1">&#39;gzz&#39;</span><span class="p">],</span>
    <span class="s1">&#39;admbase-curv&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;kxx&#39;</span><span class="p">,</span> <span class="s1">&#39;kxy&#39;</span><span class="p">,</span> <span class="s1">&#39;kxz&#39;</span><span class="p">,</span> <span class="s1">&#39;kyy&#39;</span><span class="p">,</span> <span class="s1">&#39;kyz&#39;</span><span class="p">,</span> <span class="s1">&#39;kzz&#39;</span><span class="p">],</span>
    <span class="s1">&#39;ml_bssn-ml_trace_curv&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;trK&#39;</span><span class="p">],</span>
    <span class="s1">&#39;ml_bssn-ml_ham&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span>
    <span class="s1">&#39;ml_admconstraints-ml_ham&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span>
    <span class="s1">&#39;ml_bssn-ml_mom&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;M1&#39;</span><span class="p">,</span> <span class="s1">&#39;M2&#39;</span><span class="p">,</span> <span class="s1">&#39;M3&#39;</span><span class="p">],</span>
    <span class="s1">&#39;ml_admconstraints-ml_mom&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;M1&#39;</span><span class="p">,</span> <span class="s1">&#39;M2&#39;</span><span class="p">,</span> <span class="s1">&#39;M3&#39;</span><span class="p">],</span>
    <span class="s1">&#39;weylscal4-psi4r_group&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Psi4r&#39;</span><span class="p">],</span>
    <span class="s1">&#39;weylscal4-psi4i_group&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Psi4i&#39;</span><span class="p">],</span>
    <span class="s1">&#39;cosmolapse-kthreshold&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Ktransition&#39;</span><span class="p">],</span>
    <span class="s1">&#39;cosmolapse-propertime&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;tau&#39;</span><span class="p">],</span>
    <span class="s1">&#39;carpetreduce-weight&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span>
    <span class="p">}</span>
<div class="viewcode-block" id="get_content">
<a class="viewcode-back" href="../../source/reading.html#aurel.reading.get_content">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_content</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Analyze Einstein Toolkit output directory and map variables to files.</span>

<span class="sd">    This function creates a comprehensive mapping between simulation variables</span>
<span class="sd">    and their corresponding HDF5 files, handling both single-variable and</span>
<span class="sd">    grouped-variable file organizations. It implements intelligent caching</span>
<span class="sd">    to avoid expensive file scanning on repeated calls.</span>

<span class="sd">    The function performs several key operations:</span>
<span class="sd">    1. Scans all HDF5 files in the directory</span>
<span class="sd">    2. Determines file organization (single vs. grouped variables)</span>
<span class="sd">    3. Maps each variable to its containing files</span>
<span class="sd">    4. Groups variables that share the same file sets</span>
<span class="sd">    5. Caches results for faster subsequent access</span>

<span class="sd">    Parameters</span>
<span class="sd">    ---------- </span>
<span class="sd">    param : dict</span>
<span class="sd">        Simulation parameters dictionary containing:</span>

<span class="sd">        - &#39;simpath&#39;: Path to simulation root directory</span>
<span class="sd">        - &#39;simname&#39;: Simulation name</span>
<span class="sd">    restart : int, optional</span>
<span class="sd">        Restart number to analyze. Default 0. Used to construct the path to </span>
<span class="sd">        the ET output directory containing .h5 files.</span>
<span class="sd">        Example: &quot;/simulations/BHB/output-0000/BHB/&quot;</span>

<span class="sd">    overwrite : bool, optional</span>
<span class="sd">        Overwrite existing content file. Default False.</span>
<span class="sd">        </span>
<span class="sd">    verbose : bool, optional</span>
<span class="sd">        Print progress information during processing. Default True.</span>
<span class="sd">        Shows file scanning progress and caching status.</span>
<span class="sd">        </span>
<span class="sd">    veryverbose : bool, optional</span>
<span class="sd">        Print extra progress information during processing. Default False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Dictionary mapping variable groups to their file lists::</span>

<span class="sd">        {</span>
<span class="sd">            (&#39;var1&#39;, &#39;var2&#39;): [&#39;path/to/file1.h5&#39;, &#39;path/to/file2.h5&#39;],</span>
<span class="sd">            (&#39;var3&#39;,): [&#39;path/to/file3.h5&#39;, &#39;path/to/file4.h5&#39;],</span>
<span class="sd">            ...</span>
<span class="sd">        }</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Cache file &#39;content.txt&#39; created in the target directory</span>
<span class="sd">    - Variable names follow Einstein Toolkit conventions</span>
<span class="sd">    - If variables are grouped in files and are not in the known_groups, </span>
<span class="sd">      the variable names will be retrieved from the keys in the file. </span>
<span class="sd">      Depending on the file size, this may take some time.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">restart</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;restart&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">overwrite</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;overwrite&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;verbose&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">veryverbose</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;veryverbose&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="n">path</span> <span class="o">=</span> <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;simpath&#39;</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;simname&#39;</span><span class="p">]</span>
            <span class="o">+</span> <span class="s1">&#39;/output-</span><span class="si">{:04d}</span><span class="s1">/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">restart</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;simname&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="n">content_file</span> <span class="o">=</span> <span class="n">path</span><span class="o">+</span><span class="s1">&#39;content.txt&#39;</span>

    <span class="k">if</span> <span class="n">overwrite</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removing content file from </span><span class="si">{</span><span class="n">content_file</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">content_file</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">content_file</span><span class="p">)</span>
    
    <span class="c1"># Try to load existing content file</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading existing content from </span><span class="si">{</span><span class="n">content_file</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">content_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">content_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="c1"># Convert keys back to tuples of variable names</span>
            <span class="n">vars_and_files</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">key_str</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">content_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># Convert key string back to tuple of variable names</span>
                <span class="n">key_tuple</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">key_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
                <span class="n">vars_and_files</span><span class="p">[</span><span class="n">key_tuple</span><span class="p">]</span> <span class="o">=</span> <span class="n">files</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">vars_and_files</span><span class="p">)</span><span class="si">}</span><span class="s2"> variables from cache.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No existing content file found or invalid format.&quot;</span>
              <span class="o">+</span> <span class="s2">&quot; Calculating from scratch...&quot;</span><span class="p">)</span>
        
        <span class="n">vars_and_files</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">processed_groups</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Track which groups we&#39;ve already read</span>
        <span class="n">h5files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="s1">&#39;*.h5&#39;</span><span class="p">)</span>
        <span class="c1"># skip checkpoint files</span>
        <span class="n">h5files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">h5files</span> <span class="k">if</span> <span class="s1">&#39;checkpoint.chkpt&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">f</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">filepath</span> <span class="ow">in</span> <span class="n">h5files</span><span class="p">:</span>
            <span class="n">file_info</span> <span class="o">=</span> <span class="n">parse_h5file</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">file_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">veryverbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Processing: &#39;</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># If the file is a single variable file</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">file_info</span><span class="p">[</span><span class="s1">&#39;group_file&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">veryverbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Single variable file&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">files</span> <span class="o">=</span> <span class="n">vars_and_files</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
                        <span class="n">file_info</span><span class="p">[</span><span class="s1">&#39;variable_or_group&#39;</span><span class="p">],</span> <span class="nb">set</span><span class="p">())</span>
                    <span class="n">files</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
                <span class="c1"># Else the file is a group of variables</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">veryverbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Grouped variable file&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">base_name</span> <span class="o">=</span> <span class="n">file_info</span><span class="p">[</span><span class="s1">&#39;base_name&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">base_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">processed_groups</span><span class="p">:</span>
                        <span class="c1"># If it&#39;s a known group I can skip reading the file</span>
                        <span class="k">if</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="n">known_groups</span><span class="p">:</span>
                            <span class="n">varnames</span> <span class="o">=</span> <span class="n">known_groups</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># First time seeing this group </span>
                            <span class="c1"># - read the file to get variable names</span>
                            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reading variables in file:&#39;</span><span class="p">,</span> 
                                      <span class="n">filepath</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Consider adding </span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2"> to&quot;</span>
                                      <span class="o">+</span> <span class="s2">&quot; known_groups in reading.py for&quot;</span>
                                      <span class="o">+</span> <span class="s2">&quot; faster processing.&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">h5f</span><span class="p">:</span>
                                <span class="n">variables</span> <span class="o">=</span> <span class="p">{</span><span class="n">parse_hdf5_key</span><span class="p">(</span><span class="n">k</span><span class="p">)[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span> 
                                             <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">h5f</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> 
                                             <span class="k">if</span> <span class="n">parse_hdf5_key</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>
                                <span class="n">varnames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span>
                                <span class="n">processed_groups</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">varnames</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># We&#39;ve already processed this group </span>
                        <span class="c1"># - reuse the variable names</span>
                        <span class="n">varnames</span> <span class="o">=</span> <span class="n">processed_groups</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span>
                    
                    <span class="k">if</span> <span class="n">veryverbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found the variables:&#39;</span><span class="p">,</span> <span class="n">varnames</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="c1"># Add this file to all variables in the group</span>
                    <span class="k">for</span> <span class="n">variable_name</span> <span class="ow">in</span> <span class="n">varnames</span><span class="p">:</span>
                        <span class="n">files</span> <span class="o">=</span> <span class="n">vars_and_files</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">variable_name</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>
                        <span class="n">files</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="c1"># Convert sets to lists</span>
        <span class="n">vars_and_files</span> <span class="o">=</span> <span class="p">{</span><span class="n">var</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> 
                          <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">vars_and_files</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        
        <span class="c1"># ==== Group variables by shared file paths ====</span>
        <span class="c1"># Create a mapping from file paths </span>
        <span class="c1"># (as tuples for hashability) to variables</span>
        <span class="n">files_to_vars</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">file_list</span> <span class="ow">in</span> <span class="n">vars_and_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Convert list to tuple so it can be used as a dictionary key</span>
            <span class="n">file_tuple</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">file_list</span><span class="p">))</span>
            
            <span class="k">if</span> <span class="n">file_tuple</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">files_to_vars</span><span class="p">:</span>
                <span class="n">files_to_vars</span><span class="p">[</span><span class="n">file_tuple</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">files_to_vars</span><span class="p">[</span><span class="n">file_tuple</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
        
        <span class="c1"># Invert the mapping: group variables by their shared file paths</span>
        <span class="n">vars_and_files</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">file_tuple</span><span class="p">,</span> <span class="n">var_list</span> <span class="ow">in</span> <span class="n">files_to_vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Sort variables for consistent ordering</span>
            <span class="n">var_tuple</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">var_list</span><span class="p">))</span>
            <span class="c1"># Convert file tuple back to list</span>
            <span class="n">file_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">file_tuple</span><span class="p">)</span>
            <span class="n">vars_and_files</span><span class="p">[</span><span class="n">var_tuple</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_list</span>

        <span class="c1"># ==== Save results ====</span>
        <span class="c1"># Always save the results (whether calculated </span>
        <span class="c1"># or loaded and potentially updated)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving content to </span><span class="si">{</span><span class="n">content_file</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">content_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="c1"># convert keys to strings for JSON serialization</span>
            <span class="n">content_data</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">vars_and_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">content_data</span><span class="p">[</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">content_data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">vars_and_files</span><span class="p">)</span><span class="si">}</span><span class="s2"> variables to content file.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">vars_and_files</span></div>



<span class="c1"># =============================================================================</span>
<span class="c1">#                             Reading in the data</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="read_ET_data">
<a class="viewcode-back" href="../../source/reading.html#aurel.reading.read_ET_data">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">read_ET_data</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read Einstein Toolkit simulation data with intelligent restart handling.</span>

<span class="sd">    This is the main Einstein Toolkit data reading function that handles the</span>
<span class="sd">    complexity of multi-restart simulations, variable groupings, and chunking.</span>
<span class="sd">    It provides a unified interface for accessing ET simulation data</span>
<span class="sd">    regardless of the underlying file organization.</span>

<span class="sd">    Key Features:</span>

<span class="sd">    - **Restart Management**: Automatically finds iterations across restarts</span>
<span class="sd">    - **Hybrid Reading**: Combines cached per-iteration files with ET files</span>
<span class="sd">    - **Missing Data Handling**: Fills gaps by reading from original ET files</span>
<span class="sd">    - **Variable Mapping**: Handles Aurel to Einstein Toolkit name conversions</span>
<span class="sd">    - **Caching Strategy**: Saves data in optimized format for future access</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    param : dict</span>
<span class="sd">        Simulation parameters from `parameters()` function.</span>
<span class="sd">    </span>
<span class="sd">    Other Parameters</span>
<span class="sd">    ----------------</span>
<span class="sd">    it : list of int, optional</span>
<span class="sd">        Iterations to read. Default [0].</span>
<span class="sd">    </span>
<span class="sd">    vars : list of str, optional.</span>
<span class="sd">        Variables in Aurel format. Default [] (all available). </span>
<span class="sd">        Examples: [&#39;rho&#39;, &#39;Kdown3&#39;], [&#39;gammadown3&#39;, &#39;alpha&#39;]</span>
<span class="sd">    </span>
<span class="sd">    restart : int, optional</span>
<span class="sd">        Specific restart to read from. </span>
<span class="sd">        Default -1 (auto-detect).</span>
<span class="sd">    </span>
<span class="sd">    split_per_it : bool, optional</span>
<span class="sd">        Use cached per-iteration files when available and save read data</span>
<span class="sd">        in per-iteration files. Default True.</span>
<span class="sd">    </span>
<span class="sd">    usecheckpoints : bool, optional</span>
<span class="sd">        For ET data: whether to use checkpoint iterations if available. </span>
<span class="sd">        Default False.</span>
<span class="sd">    </span>
<span class="sd">    verbose : bool, optional</span>
<span class="sd">        Print progress information. Default True.</span>
<span class="sd">    </span>
<span class="sd">    veryverbose : bool, optional</span>
<span class="sd">        Print detailed debugging information. Default False.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Simulation data dictionary with structure::</span>
<span class="sd">        </span>
<span class="sd">            {</span>
<span class="sd">                &#39;it&#39;: [iteration_numbers],</span>
<span class="sd">                &#39;t&#39;: [time_values],</span>
<span class="sd">                &#39;var1&#39;: [data_arrays],</span>
<span class="sd">                &#39;var2&#39;: [data_arrays],</span>
<span class="sd">                ...</span>
<span class="sd">            }</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Processing Workflow:</span>
<span class="sd">    </span>
<span class="sd">    1. **Iteration Location**: Determines which restart contains each iteration</span>
<span class="sd">    2. **Cache Reading**: Loads available data from per-iteration files  </span>
<span class="sd">    3. **Gap Detection**: Identifies missing iterations/variables</span>
<span class="sd">    4. **ET Reading**: Fills gaps by reading original Einstein Toolkit files</span>
<span class="sd">    5. **Data Integration**: Combines cached and newly-read data</span>
<span class="sd">    6. **Cache Update**: Saves newly-read data for future access</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># reading kwargs</span>
    <span class="n">it</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;it&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]))))</span>
    <span class="n">var</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vars&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">restart</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;restart&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">split_per_it</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;split_per_it&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">usecheckpoints</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;usecheckpoints&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;verbose&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">veryverbose</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;veryverbose&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="c1"># =========================================================================</span>
    <span class="c1"># ======== set up iterations to get and which restart it&#39;s in</span>
    <span class="c1"># Overall information</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;verbose_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">its_available</span> <span class="o">=</span> <span class="n">iterations</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="c1"># use user provided restart</span>
    <span class="k">if</span> <span class="n">restart</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">restarts_available</span> <span class="o">=</span> <span class="p">[</span><span class="n">restart</span><span class="p">]</span>
        <span class="n">its_available</span><span class="p">[</span><span class="n">restart</span><span class="p">][</span><span class="s1">&#39;it to do&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">iit</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">usecheckpoints</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;checkpoints&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">its_available</span><span class="p">[</span><span class="n">restart</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">iit</span> <span class="ow">in</span> <span class="n">its_available</span><span class="p">[</span><span class="n">restart</span><span class="p">][</span><span class="s1">&#39;checkpoints&#39;</span><span class="p">]:</span>
                        <span class="n">its_available</span><span class="p">[</span><span class="n">restart</span><span class="p">][</span><span class="s1">&#39;it to do&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">iit</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;its available&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">its_available</span><span class="p">[</span><span class="n">restart</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">its_available</span><span class="p">[</span><span class="n">restart</span><span class="p">][</span><span class="s1">&#39;its available&#39;</span><span class="p">])</span> <span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">iit</span> <span class="o">==</span> <span class="n">its_available</span><span class="p">[</span><span class="n">restart</span><span class="p">][</span><span class="s1">&#39;its available&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                            <span class="n">its_available</span><span class="p">[</span><span class="n">restart</span><span class="p">][</span><span class="s1">&#39;it to do&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">iit</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">itmin</span><span class="p">,</span> <span class="n">itmax</span> <span class="o">=</span> <span class="n">its_available</span><span class="p">[</span><span class="n">restart</span><span class="p">][</span><span class="s1">&#39;its available&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="p">((</span><span class="n">itmin</span> <span class="o">&lt;=</span> <span class="n">iit</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">iit</span> <span class="o">&lt;=</span> <span class="n">itmax</span><span class="p">)):</span>
                            <span class="n">its_available</span><span class="p">[</span><span class="n">restart</span><span class="p">][</span><span class="s1">&#39;it to do&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">iit</span><span class="p">]</span>
    <span class="c1"># find restart myself</span>
    <span class="k">elif</span> <span class="n">restart</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">restarts_available</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">its_available</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="c1"># create new element containing iterations to do</span>
        <span class="k">for</span> <span class="n">restart</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">its_available</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">its_available</span><span class="p">[</span><span class="n">restart</span><span class="p">][</span><span class="s1">&#39;it to do&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># reverse order so that I&#39;m always taking the most recent iteration</span>
        <span class="k">for</span> <span class="n">iit</span> <span class="ow">in</span> <span class="n">it</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">restart</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">its_available</span><span class="o">.</span><span class="n">keys</span><span class="p">())[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">usecheckpoints</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;checkpoints&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">its_available</span><span class="p">[</span><span class="n">restart</span><span class="p">]):</span>
                        <span class="n">it_in_restart</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># is this iteration a checkpoint within this restart?</span>
                        <span class="k">if</span> <span class="n">iit</span> <span class="ow">in</span> <span class="n">its_available</span><span class="p">[</span><span class="n">restart</span><span class="p">][</span><span class="s1">&#39;checkpoints&#39;</span><span class="p">]:</span>
                            <span class="n">it_in_restart</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">it_in_restart</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;its available&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">its_available</span><span class="p">[</span><span class="n">restart</span><span class="p">]):</span>
                        <span class="n">it_in_restart</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># is this iteration available within this restart?</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">its_available</span><span class="p">[</span><span class="n">restart</span><span class="p">][</span><span class="s1">&#39;its available&#39;</span><span class="p">])</span> <span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                            <span class="n">it_in_restart</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">iit</span> <span class="o">==</span> <span class="n">its_available</span><span class="p">[</span><span class="n">restart</span><span class="p">][</span><span class="s1">&#39;its available&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">itmin</span><span class="p">,</span> <span class="n">itmax</span> <span class="o">=</span> <span class="n">its_available</span><span class="p">[</span><span class="n">restart</span><span class="p">][</span><span class="s1">&#39;its available&#39;</span><span class="p">]</span>
                            <span class="n">it_in_restart</span> <span class="o">=</span> <span class="p">((</span><span class="n">itmin</span> <span class="o">&lt;=</span> <span class="n">iit</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">iit</span> <span class="o">&lt;=</span> <span class="n">itmax</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">it_in_restart</span><span class="p">:</span>
                    <span class="n">its_available</span><span class="p">[</span><span class="n">restart</span><span class="p">][</span><span class="s1">&#39;it to do&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">iit</span><span class="p">]</span>
                    <span class="c1"># I found it, so break to not go through the other restart</span>
                    <span class="k">break</span>

        <span class="c1"># sort iterations</span>
        <span class="k">for</span> <span class="n">restart</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">its_available</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">its_available</span><span class="p">[</span><span class="n">restart</span><span class="p">][</span><span class="s1">&#39;it to do&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span>
                    <span class="n">its_available</span><span class="p">[</span><span class="n">restart</span><span class="p">][</span><span class="s1">&#39;it to do&#39;</span><span class="p">]))</span>
    <span class="c1"># can&#39;t read restart value</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Don&#39;t know what to do with restart=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">restart</span><span class="p">))</span>

    <span class="c1"># =========================================================================</span>
    <span class="c1"># ======== go collect data in each restart</span>
    <span class="c1"># big dictionary to save data and to be flattened</span>
    <span class="n">datar</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">old_it</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">restart</span> <span class="ow">in</span> <span class="n">restarts_available</span><span class="p">:</span>
        <span class="c1"># iterations available in this restart</span>
        <span class="n">it</span> <span class="o">=</span> <span class="n">its_available</span><span class="p">[</span><span class="n">restart</span><span class="p">][</span><span class="s1">&#39;it to do&#39;</span><span class="p">]</span>
        <span class="c1"># skip this restart if it doesn&#39;t have the it we want</span>
        <span class="k">if</span> <span class="n">it</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="k">pass</span>
        <span class="c1"># go collect data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># ====== set things up</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;it&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">it</span>

            <span class="c1"># restart</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;restart&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">restart</span>
            <span class="n">vars_and_files</span> <span class="o">=</span> <span class="n">get_content</span><span class="p">(</span>
                <span class="n">param</span><span class="p">,</span> <span class="n">restart</span><span class="o">=</span><span class="n">restart</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            
            <span class="c1"># if no variable is specified, take all available</span>
            <span class="k">if</span> <span class="n">var</span><span class="o">==</span><span class="p">[]:</span>
                <span class="n">var</span> <span class="o">=</span> <span class="n">its_available</span><span class="p">[</span><span class="n">restart</span><span class="p">][</span><span class="s1">&#39;var available&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; =========== Restart </span><span class="si">{}</span><span class="s1">:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">restart</span><span class="p">),</span> 
                        <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;vars to get </span><span class="si">{}</span><span class="s1">:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">veryverbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;its to get </span><span class="si">{}</span><span class="s1">:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">it</span><span class="p">),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># ====== checkpoints</span>
            <span class="k">if</span> <span class="n">usecheckpoints</span><span class="p">:</span>
                <span class="n">datar</span><span class="p">[</span><span class="n">restart</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_ET_checkpoints</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
            
                <span class="c1"># ====== directly read and provide the data</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">split_per_it</span><span class="p">:</span>
                    <span class="n">datar</span><span class="p">[</span><span class="n">restart</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_ET_variables</span><span class="p">(</span>
                        <span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">vars_and_files</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    
                <span class="c1"># ====== combination of Einstein Toolkit data and aurel data</span>
                <span class="c1"># + save into it files for quicker reading next time</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># ====== change variable names to scalar elements</span>
                    <span class="n">avar</span> <span class="o">=</span> <span class="n">transform_vars_tensor_to_scalar</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;vars&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">avar</span>

                    <span class="c1"># =========================================================</span>
                    <span class="c1"># ======= Get variables from split iterations files</span>
                    <span class="c1"># Read in data</span>
                    <span class="n">datar</span><span class="p">[</span><span class="n">restart</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_aurel_data</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="n">verbose_cleaned_dict</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">datar</span><span class="p">[</span><span class="n">restart</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> 
                            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> 
                                        <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">))</span>
                                <span class="ow">and</span> <span class="n">k</span><span class="o">!=</span><span class="s1">&#39;it&#39;</span><span class="p">)}</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Data read from split iterations:&#39;</span><span class="p">,</span> 
                                <span class="nb">list</span><span class="p">(</span><span class="n">verbose_cleaned_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        
                    <span class="c1"># Find iterations missing</span>
                    <span class="n">avart</span> <span class="o">=</span> <span class="n">avar</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span>
                    <span class="n">its_missing</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">avart</span><span class="p">}</span>
                    <span class="k">for</span> <span class="n">it_idx</span><span class="p">,</span> <span class="n">iit</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">it</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">av</span> <span class="ow">in</span> <span class="n">avart</span><span class="p">:</span>
                            <span class="c1"># Include it if it&#39;s not present</span>
                            <span class="k">if</span> <span class="n">datar</span><span class="p">[</span><span class="n">restart</span><span class="p">][</span><span class="n">av</span><span class="p">][</span><span class="n">it_idx</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">its_missing</span><span class="p">[</span><span class="n">av</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">iit</span><span class="p">]</span>
                            <span class="c1"># Do a set to not have repeats</span>
                            <span class="n">its_missing</span><span class="p">[</span><span class="n">av</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">its_missing</span><span class="p">[</span><span class="n">av</span><span class="p">]))</span>
                    <span class="c1"># Need to sort because of the set</span>
                    <span class="k">for</span> <span class="n">av</span> <span class="ow">in</span> <span class="n">avart</span><span class="p">:</span>
                        <span class="n">its_missing</span><span class="p">[</span><span class="n">av</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">its_missing</span><span class="p">[</span><span class="n">av</span><span class="p">]))</span>

                    <span class="c1"># Verbose update</span>
                    <span class="k">if</span> <span class="n">veryverbose</span><span class="p">:</span>
                        <span class="n">verbose_clean_its_missing</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">its_missing</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span><span class="o">!=</span> <span class="p">[]}</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Iterations missing:&#39;</span><span class="p">,</span> 
                                <span class="n">verbose_clean_its_missing</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                                

                    <span class="c1"># =========================================================</span>
                    <span class="c1"># ======== Collect missing data from ET data</span>
                    <span class="n">ETread_vars</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">verbose_saved_vars</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="c1"># if variables not grouped, read, join and save them</span>
                    <span class="c1"># one by one</span>
                    <span class="n">variables_grouped</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">for</span> <span class="n">vgroup</span> <span class="ow">in</span> <span class="n">vars_and_files</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vgroup</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">variables_grouped</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">variables_grouped</span><span class="p">:</span>
                        <span class="n">newvar</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">var</span><span class="p">:</span>
                            <span class="n">av</span> <span class="o">=</span> <span class="n">transform_vars_tensor_to_scalar</span><span class="p">([</span><span class="n">v</span><span class="p">])</span>
                            <span class="n">newvar</span> <span class="o">+=</span> <span class="n">av</span>
                        <span class="n">var</span> <span class="o">=</span> <span class="n">newvar</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                    <span class="c1"># Now process each variable</span>
                    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">var</span><span class="p">:</span>
                        <span class="c1"># collect missing iterations</span>
                        <span class="n">avar</span> <span class="o">=</span> <span class="n">transform_vars_tensor_to_scalar</span><span class="p">([</span><span class="n">v</span><span class="p">])</span>
                        <span class="n">its_temp</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">av</span> <span class="ow">in</span> <span class="n">avar</span> 
                                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">its_missing</span><span class="p">[</span><span class="n">av</span><span class="p">]]</span>
                        <span class="n">its_temp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">its_temp</span><span class="p">))</span>
                        <span class="c1"># if there are missing iterations</span>
                        <span class="k">if</span> <span class="n">its_temp</span> <span class="o">!=</span> <span class="p">[]:</span>
                            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;it&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">its_temp</span>
                            <span class="c1"># retrieve missing iterations</span>
                            <span class="n">data_temp</span> <span class="o">=</span> <span class="n">read_ET_variables</span><span class="p">(</span>
                                    <span class="n">param</span><span class="p">,</span> <span class="p">[</span><span class="n">v</span><span class="p">],</span> <span class="n">vars_and_files</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                            <span class="c1"># verbose update</span>
                            <span class="n">ETread_vars</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_temp</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                            <span class="k">if</span> <span class="n">veryverbose</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Data read from ET files:&#39;</span><span class="p">,</span> 
                                        <span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_temp</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="c1"># update the data with the missing iterations</span>
                            <span class="n">avart</span> <span class="o">=</span> <span class="n">avar</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">av</span> <span class="ow">in</span> <span class="n">avart</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">data_temp</span><span class="p">[</span><span class="n">av</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="k">for</span> <span class="n">iidx</span><span class="p">,</span> <span class="n">iit</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">it</span><span class="p">):</span>
                                        <span class="k">if</span> <span class="n">iit</span> <span class="ow">in</span> <span class="n">its_missing</span><span class="p">[</span><span class="n">av</span><span class="p">]:</span>
                                            <span class="n">iidxtem</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
                                                <span class="n">data_temp</span><span class="p">[</span><span class="s1">&#39;it&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">iit</span><span class="p">))</span>
                                            <span class="n">datar</span><span class="p">[</span><span class="n">restart</span><span class="p">][</span><span class="n">av</span><span class="p">][</span><span class="n">iidx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                                <span class="n">data_temp</span><span class="p">[</span><span class="n">av</span><span class="p">][</span><span class="n">iidxtem</span><span class="p">])</span>
                                            <span class="c1"># don&#39;t save this iteration</span>
                                            <span class="k">if</span> <span class="p">(</span><span class="n">data_temp</span><span class="p">[</span><span class="n">av</span><span class="p">][</span><span class="n">iidxtem</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span>
                                                <span class="ow">or</span> <span class="n">av</span> <span class="o">==</span> <span class="s1">&#39;t&#39;</span><span class="p">):</span>
                                                <span class="n">its_missing</span><span class="p">[</span><span class="n">av</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">iit</span><span class="p">)</span>
                                                
                                    <span class="k">if</span> <span class="n">its_missing</span><span class="p">[</span><span class="n">av</span><span class="p">]</span> <span class="o">!=</span> <span class="p">[]:</span>
                                        <span class="c1"># save the missing iterations</span>
                                        <span class="c1"># and save them individually</span>
                                        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;it&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">its_missing</span><span class="p">[</span><span class="n">av</span><span class="p">]</span>
                                        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;vars&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">av</span><span class="p">]</span>
                                        <span class="n">verbose_saved_vars</span> <span class="o">+=</span> <span class="p">[</span><span class="n">av</span><span class="p">]</span>
                                        <span class="k">if</span> <span class="n">veryverbose</span><span class="p">:</span>
                                            <span class="nb">print</span><span class="p">(</span>
                                                <span class="s1">&#39;Saving data for </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">av</span><span class="p">)</span>
                                                <span class="o">+</span> <span class="s1">&#39; at it = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                    <span class="n">its_missing</span><span class="p">[</span><span class="n">av</span><span class="p">]),</span> 
                                                <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                                        <span class="n">save_data</span><span class="p">(</span>
                                            <span class="n">param</span><span class="p">,</span> <span class="n">data_temp</span><span class="p">,</span>
                                            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="n">ETread_vars</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ETread_vars</span><span class="p">))</span>
                        <span class="n">verbose_saved_vars</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">verbose_saved_vars</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">ETread_vars</span> <span class="o">!=</span> <span class="p">[]:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Variables read from ET files:&#39;</span><span class="p">,</span> 
                                <span class="n">ETread_vars</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">verbose_saved_vars</span> <span class="o">!=</span> <span class="p">[]:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Variables saved to split iterations files:&#39;</span><span class="p">,</span>
                                <span class="n">verbose_saved_vars</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># create ultimate data dictionary (flattening datar)</span>
    <span class="k">if</span> <span class="n">veryverbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; =========== Joining the data from the different restarts&#39;</span><span class="p">)</span>
    <span class="n">restart</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">datar</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">datar</span><span class="p">[</span><span class="n">restart</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># copy over everything from datar</span>
    <span class="k">for</span> <span class="n">iit</span> <span class="ow">in</span> <span class="n">old_it</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">restart</span> <span class="ow">in</span> <span class="n">datar</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">iit</span> <span class="ow">in</span> <span class="n">datar</span><span class="p">[</span><span class="n">restart</span><span class="p">][</span><span class="s1">&#39;it&#39;</span><span class="p">]:</span>
                <span class="n">it_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">datar</span><span class="p">[</span><span class="n">restart</span><span class="p">][</span><span class="s1">&#39;it&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">iit</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">datar</span><span class="p">[</span><span class="n">restart</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">datar</span><span class="p">[</span><span class="n">restart</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="n">it_index</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="read_ET_variables">
<a class="viewcode-back" href="../../source/reading.html#aurel.reading.read_ET_variables">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">read_ET_variables</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">vars_and_files</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the data from Einstein Toolkit simulation output files.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    param : dict</span>
<span class="sd">        The parameters of the simulation.</span>
<span class="sd">    var : list</span>
<span class="sd">        The variables to read from the simulation output files.</span>

<span class="sd">    Other Parameters</span>
<span class="sd">    ----------------</span>
<span class="sd">    it : list, optional</span>
<span class="sd">        The iterations to save from the data.</span>
<span class="sd">        The default is [0].</span>
<span class="sd">    rl : int, optional</span>
<span class="sd">        The refinement level to read from the simulation output files.</span>
<span class="sd">        The default is 0.</span>
<span class="sd">    restart : int, optional</span>
<span class="sd">        The restart number to save the data to.</span>
<span class="sd">        The default is 0.</span>
<span class="sd">    veryverbose : bool, optional</span>
<span class="sd">        If True, print additional information during the joining process.</span>
<span class="sd">        The default is False.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        A dictionary containing the data from the simulation output files.</span>
<span class="sd">        dict.keys() = [&#39;it&#39;, &#39;t&#39;, var[0], var[1], ...]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">it</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;it&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]))))</span>
    <span class="n">veryverbose</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;veryverbose&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">veryverbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;read_ET_variables was given the vars:&#39;</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># data to be returned</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;it&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">it</span><span class="p">),</span> <span class="s1">&#39;t&#39;</span><span class="p">:[]}</span>
    
    <span class="c1"># are the chunks together in one file or one file per chunk?</span>
    <span class="n">first_var</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">vars_and_files</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">first_file_of_first_var</span> <span class="o">=</span> <span class="n">vars_and_files</span><span class="p">[</span><span class="n">first_var</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;.file_&#39;</span> <span class="ow">in</span> <span class="n">first_file_of_first_var</span><span class="p">:</span>
        <span class="c1"># one file per chunk</span>
        <span class="n">cmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">parse_h5file</span><span class="p">(</span><span class="n">fp</span><span class="p">)[</span><span class="s1">&#39;chunk_number&#39;</span><span class="p">]</span> 
                       <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="n">vars_and_files</span><span class="p">[</span><span class="n">first_var</span><span class="p">]])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cmax</span> <span class="o">=</span> <span class="s1">&#39;in file&#39;</span>

    <span class="c1"># Translate var names from aurel to ET</span>
    <span class="n">var_ET</span> <span class="o">=</span> <span class="n">transform_vars_aurel_to_ET</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">veryverbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;In read_ET_variables looking for variables:&#39;</span><span class="p">,</span> 
              <span class="n">var_ET</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Create a dictionary to hold the wanted variables and their files</span>
    <span class="n">vars_wanted</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">var_ET</span><span class="p">:</span>
        <span class="n">var_found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># have I already copied it over?</span>
        <span class="k">for</span> <span class="n">v_want</span> <span class="ow">in</span> <span class="n">vars_wanted</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">v_want</span><span class="p">:</span>
                <span class="n">var_found</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
        <span class="c1"># copy it over if I haven&#39;t found it yet</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">var_found</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">v_avail</span> <span class="ow">in</span> <span class="n">vars_and_files</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">v_avail</span><span class="p">:</span>
                    <span class="n">vars_wanted</span><span class="p">[</span><span class="n">v_avail</span><span class="p">]</span> <span class="o">=</span> <span class="n">vars_and_files</span><span class="p">[</span><span class="n">v_avail</span><span class="p">]</span>
                    <span class="n">var_found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
        <span class="c1"># if I still haven&#39;t found it, print a warning</span>
        <span class="c1"># and don&#39;t read it</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">var_found</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Variable </span><span class="si">{}</span><span class="s1"> not found&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

    <span class="c1"># Get all the data</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vars_wanted</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">read_ET_group_or_var</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">vars_wanted</span><span class="p">[</span><span class="n">v</span><span class="p">],</span> <span class="n">cmax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">veryverbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;In read_ET_variables we found:&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="read_ET_group_or_var">
<a class="viewcode-back" href="../../source/reading.html#aurel.reading.read_ET_group_or_var">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">read_ET_group_or_var</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">cmax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read variables from Einstein Toolkit simulation output files.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    variables : list</span>
<span class="sd">        The variables to read from the simulation output files.</span>
<span class="sd">        Each variable is a string that identifies the variable.</span>
<span class="sd">        These should all be found in the same files.</span>
<span class="sd">    files : list</span>
<span class="sd">        The list of files to read the variables from.</span>
<span class="sd">        Each file is a string that identifies the file.</span>
<span class="sd">        These should all contain the same variables just at different chunks.</span>
<span class="sd">    cmax : int</span>
<span class="sd">        The maximum number of chunks to read from the simulation output files.</span>
<span class="sd">        If &#39;in file&#39;, it will be extracted from the file.</span>

<span class="sd">    Other Parameters</span>
<span class="sd">    ----------------</span>
<span class="sd">    it : list, optional</span>
<span class="sd">        The iterations to save from the data.</span>
<span class="sd">        The default is [0].</span>
<span class="sd">    rl : int, optional</span>
<span class="sd">        The refinement level to read from the simulation output files.</span>
<span class="sd">        The default is 0.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        A dictionary containing the data from the simulation output files.</span>

<span class="sd">        dict.keys() = [&#39;it&#39;, &#39;t&#39;, var]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">it</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;it&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]))))</span>
    <span class="n">rl</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">veryextraverbose</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;veryextraverbose&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Validate cmax parameter</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">cmax</span> <span class="o">==</span> <span class="s1">&#39;in file&#39;</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cmax</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">))):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;cmax must be either &#39;in file&#39; or an integer. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">cmax</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">cmax</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cmax</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">))</span> <span class="ow">and</span> <span class="n">cmax</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;cmax must be a non-negative integer. Got </span><span class="si">{</span><span class="n">cmax</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">veryextraverbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;read_ET_group_or_var(variables, files, cmax) activated with:&#39;</span><span class="p">,</span> 
              <span class="n">variables</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">cmax</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="n">var_chunks</span> <span class="o">=</span> <span class="p">{</span><span class="n">iit</span><span class="p">:{}</span> <span class="k">for</span> <span class="n">iit</span> <span class="ow">in</span> <span class="n">it</span><span class="p">}</span>
    
    <span class="c1"># also collect time while you&#39;re at it</span>
    <span class="n">time</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">collect_time</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># go through one file at a time</span>
    <span class="k">for</span> <span class="n">filepath</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="c1"># open the file and collect data</span>
        <span class="n">file_present</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file_present</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">veryextraverbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reading file: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filepath</span><span class="p">),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="c1"># Find all keys that are valid</span>
                <span class="n">file_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> 
                             <span class="k">if</span> <span class="n">parse_hdf5_key</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
                <span class="c1"># Collect all it of that file</span>
                <span class="k">for</span> <span class="n">iit</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
                    <span class="n">relevant_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">file_keys</span> 
                                     <span class="k">if</span> <span class="p">((</span><span class="n">parse_hdf5_key</span><span class="p">(</span><span class="n">k</span><span class="p">)[</span><span class="s1">&#39;it&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">iit</span><span class="p">)</span>
                                     <span class="ow">and</span> <span class="p">(</span><span class="n">parse_hdf5_key</span><span class="p">(</span><span class="n">k</span><span class="p">)[</span><span class="s1">&#39;rl&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">rl</span><span class="p">))]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">relevant_keys</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Could not find </span><span class="si">{</span><span class="n">variables</span><span class="si">}</span><span class="s2"> for it </span><span class="si">{</span><span class="n">iit</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; and rl </span><span class="si">{</span><span class="n">rl</span><span class="si">}</span><span class="s2"> in file: </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        
                    <span class="c1"># find the actual number of chunks</span>
                    <span class="k">if</span> <span class="n">cmax</span> <span class="o">==</span> <span class="s1">&#39;in file&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;c=&#39;</span> <span class="ow">in</span> <span class="n">relevant_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                            <span class="n">actual_cmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
                                <span class="p">[</span><span class="n">parse_hdf5_key</span><span class="p">(</span><span class="n">k</span><span class="p">)[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span> 
                                 <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">relevant_keys</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">actual_cmax</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">relevant_keys_with_c</span> <span class="o">=</span> <span class="n">relevant_keys</span>
                        <span class="n">crange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">actual_cmax</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">actual_cmax</span> <span class="o">=</span> <span class="n">cmax</span>
                        <span class="n">crange</span> <span class="o">=</span> <span class="p">[</span><span class="n">parse_h5file</span><span class="p">(</span><span class="n">filepath</span><span class="p">)[</span><span class="s1">&#39;chunk_number&#39;</span><span class="p">]]</span>
                            
                    <span class="c1"># for each chunk</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">crange</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">actual_cmax</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span> 
                            <span class="n">relevant_keys_with_c</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">relevant_keys</span> 
                                     <span class="k">if</span> <span class="p">((</span><span class="n">parse_hdf5_key</span><span class="p">(</span><span class="n">k</span><span class="p">)[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">c</span><span class="p">))]</span>
                             
                        <span class="c1"># For each component</span>
                        <span class="k">for</span> <span class="n">vi</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">variables</span><span class="p">):</span>
                            <span class="c1"># the full key to use</span>
                            <span class="n">key</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">relevant_keys_with_c</span>
                                   <span class="k">if</span> <span class="p">(</span><span class="n">parse_hdf5_key</span><span class="p">(</span><span class="n">k</span><span class="p">)[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">v</span>
                                       <span class="ow">or</span> <span class="n">parse_hdf5_key</span><span class="p">(</span><span class="n">k</span><span class="p">)[</span>
                                           <span class="s1">&#39;combined variable name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">v</span><span class="p">)]</span>
                            <span class="c1"># should be only one key</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">other</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; it=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">key</span><span class="p">]</span>
                                <span class="n">is_rest_same</span> <span class="o">=</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span>
                                    <span class="p">[</span><span class="n">other</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">other</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> 
                                     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)])</span> 
                                     <span class="o">==</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                                <span class="k">if</span> <span class="n">is_rest_same</span><span class="p">:</span>
                                    <span class="n">mult_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; it=&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> 
                                                 <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">key</span><span class="p">]</span>
                                    <span class="n">variables</span><span class="p">[</span><span class="n">vi</span><span class="p">]</span> <span class="o">=</span> <span class="n">mult_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                    <span class="n">variables</span> <span class="o">+=</span> <span class="n">mult_vars</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                                    <span class="n">v</span> <span class="o">=</span> <span class="n">mult_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                                    <span class="n">key</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">relevant_keys_with_c</span>
                                           <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">k</span><span class="p">]</span>
                                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                            <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                                            <span class="o">+</span> <span class="s1">&#39; keys found for variable &#39;</span>
                                            <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> it=</span><span class="si">{}</span><span class="s1"> rl=</span><span class="si">{}</span><span class="s1"> c=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                <span class="n">v</span><span class="p">,</span> <span class="n">iit</span><span class="p">,</span> <span class="n">rl</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
                                            <span class="o">+</span> <span class="s1">&#39; found: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                        <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                                        <span class="o">+</span> <span class="s1">&#39; keys found for variable &#39;</span>
                                        <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> it=</span><span class="si">{}</span><span class="s1"> rl=</span><span class="si">{}</span><span class="s1"> c=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                            <span class="n">v</span><span class="p">,</span> <span class="n">iit</span><span class="p">,</span> <span class="n">rl</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
                                        <span class="o">+</span> <span class="s1">&#39; found: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            
                            <span class="c1"># Read in the variable</span>
                            <span class="k">if</span> <span class="n">veryextraverbose</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reading key = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> 
                                      <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="n">var_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                            <span class="c1"># Cut off ghost grid points</span>
                            <span class="n">ghost_x</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;cctk_nghostzones&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">ghost_y</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;cctk_nghostzones&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">ghost_z</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;cctk_nghostzones&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                            <span class="n">var_array</span> <span class="o">=</span> <span class="n">var_array</span><span class="p">[</span><span class="n">ghost_z</span><span class="p">:</span><span class="o">-</span><span class="n">ghost_z</span><span class="p">,</span> 
                                                  <span class="n">ghost_y</span><span class="p">:</span><span class="o">-</span><span class="n">ghost_y</span><span class="p">,</span> 
                                                  <span class="n">ghost_x</span><span class="p">:</span><span class="o">-</span><span class="n">ghost_x</span><span class="p">]</span>
                            <span class="n">iorigin</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;iorigin&#39;</span><span class="p">])</span>
                            <span class="n">var_chunks</span><span class="p">[</span><span class="n">iit</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">{})[</span><span class="n">iorigin</span><span class="p">]</span> <span class="o">=</span> <span class="n">var_array</span>
                            <span class="k">del</span> <span class="n">var_array</span>
                    <span class="k">if</span> <span class="n">collect_time</span><span class="p">:</span>
                        <span class="n">time</span> <span class="o">+=</span> <span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]]</span>
                <span class="n">collect_time</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># only do this in one file</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;File </span><span class="si">{}</span><span class="s1"> not found&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filepath</span><span class="p">),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">break</span>

    <span class="c1"># per iteration</span>
    <span class="c1"># join the chunks together + fix the indexing to be x, y, z</span>
    <span class="n">var</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">iit</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">veryextraverbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Joining chunks for </span><span class="si">{}</span><span class="s1"> at it = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">iit</span><span class="p">),</span> 
                      <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">aurel_v</span> <span class="o">=</span> <span class="n">transform_vars_ET_to_aurel</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="n">varlist</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">aurel_v</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">varlist</span> <span class="o">+=</span> <span class="p">[</span><span class="n">fixij</span><span class="p">(</span><span class="n">join_chunks</span><span class="p">(</span>
                <span class="n">var_chunks</span><span class="p">[</span><span class="n">iit</span><span class="p">][</span><span class="n">v</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))]</span>
        <span class="n">var</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span>
        
    <span class="k">return</span> <span class="n">var</span></div>


<div class="viewcode-block" id="read_ET_checkpoints">
<a class="viewcode-back" href="../../source/reading.html#aurel.reading.read_ET_checkpoints">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">read_ET_checkpoints</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the data from Einstein Toolkit simulation checkpoint files.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    param : dict</span>
<span class="sd">        The parameters of the simulation.</span>
<span class="sd">    var : list</span>
<span class="sd">        The variables to read from the simulation checkpoint files.</span>

<span class="sd">    Other Parameters</span>
<span class="sd">    ----------------</span>
<span class="sd">    it : list</span>
<span class="sd">        The iterations to read from the simulation checkpoint files.</span>
<span class="sd">    restart : int</span>
<span class="sd">        The restart number to read from.</span>
<span class="sd">    rl : int</span>
<span class="sd">        The refinement level to read from the simulation checkpoint files.</span>
<span class="sd">    verbose : bool, optional</span>
<span class="sd">        Print progress information. Default True.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        A dictionary containing the data from the simulation checkpoint files.</span>
<span class="sd">        dict.keys() = [&#39;it&#39;, &#39;t&#39;, var[0], var[1], ...]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">var</span> <span class="o">=</span> <span class="n">transform_vars_aurel_to_ET</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="n">it</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;it&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]))))</span>
    <span class="n">restart</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;restart&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">rl</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;verbose&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">veryverbose</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;veryverbose&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">veryextraverbose</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;veryextraverbose&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using checkpoints for restart </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">restart</span><span class="p">),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">checkpoint_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span>
        <span class="n">param</span><span class="p">[</span><span class="s1">&#39;simpath&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;simname&#39;</span><span class="p">]</span>
        <span class="o">+</span> <span class="s1">&#39;/output-</span><span class="si">{:04d}</span><span class="s1">/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">restart</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;simname&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/checkpoint.chkpt.it_*.h5&#39;</span><span class="p">)</span>
    
    <span class="c1"># find cmax</span>
    <span class="n">it0_file</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">it0_file</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="n">it0</span> <span class="o">=</span> <span class="n">it</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">it0_file</span> <span class="o">=</span> <span class="p">[</span><span class="n">cf</span> <span class="k">for</span> <span class="n">cf</span> <span class="ow">in</span> <span class="n">checkpoint_files</span> 
                    <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;it_</span><span class="si">{</span><span class="n">it0</span><span class="si">}</span><span class="s2">.&quot;</span> <span class="ow">in</span> <span class="n">cf</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">it0_file</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">it0_file</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">cmax</span> <span class="o">=</span> <span class="s1">&#39;in file&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">parse_h5file</span><span class="p">(</span><span class="n">cf</span><span class="p">)[</span><span class="s1">&#39;chunk_number&#39;</span><span class="p">]</span> 
                           <span class="k">for</span> <span class="n">cf</span> <span class="ow">in</span> <span class="n">it0_file</span><span class="p">])</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># data to be returned</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;it&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">it</span><span class="p">),</span> <span class="s1">&#39;t&#39;</span><span class="p">:[]}</span>
    <span class="k">for</span> <span class="n">iit</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">veryverbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reading checkpoint for it=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iit</span><span class="p">),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">it_file</span> <span class="o">=</span> <span class="p">[</span><span class="n">cf</span> <span class="k">for</span> <span class="n">cf</span> <span class="ow">in</span> <span class="n">checkpoint_files</span> 
                    <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;it_</span><span class="si">{</span><span class="n">iit</span><span class="si">}</span><span class="s2">.&quot;</span> <span class="ow">in</span> <span class="n">cf</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">it_file</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="n">collect_time</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">var_chunks</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">it_file</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">veryextraverbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reading checkpoint file: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="p">),</span> 
                            <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        
                    <span class="c1"># keys </span>
                    <span class="n">file_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> 
                                 <span class="k">if</span> <span class="n">parse_hdf5_key</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
                    <span class="n">relevant_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">file_keys</span> 
                                     <span class="k">if</span> <span class="p">((</span><span class="n">parse_hdf5_key</span><span class="p">(</span><span class="n">k</span><span class="p">)[</span><span class="s1">&#39;it&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">iit</span><span class="p">)</span>
                                     <span class="ow">and</span> <span class="p">(</span><span class="n">parse_hdf5_key</span><span class="p">(</span><span class="n">k</span><span class="p">)[</span><span class="s1">&#39;rl&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">rl</span><span class="p">)</span>
                                     <span class="ow">and</span> <span class="p">(</span><span class="n">parse_hdf5_key</span><span class="p">(</span><span class="n">k</span><span class="p">)[</span><span class="s1">&#39;tl&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))]</span>
                    
                    <span class="c1"># max number of chunks</span>
                    <span class="k">if</span> <span class="n">cmax</span> <span class="o">==</span> <span class="s1">&#39;in file&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;c=&#39;</span> <span class="ow">in</span> <span class="n">relevant_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                            <span class="n">nochunks</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">actual_cmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
                                <span class="p">[</span><span class="n">parse_hdf5_key</span><span class="p">(</span><span class="n">k</span><span class="p">)[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span> 
                                 <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">relevant_keys</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">nochunks</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">actual_cmax</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">crange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">actual_cmax</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">nochunks</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">actual_cmax</span> <span class="o">=</span> <span class="n">cmax</span>
                        <span class="n">crange</span> <span class="o">=</span> <span class="p">[</span><span class="n">parse_h5file</span><span class="p">(</span><span class="n">file</span><span class="p">)[</span><span class="s1">&#39;chunk_number&#39;</span><span class="p">]]</span>

                    <span class="k">for</span> <span class="n">vi</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
                        <span class="n">varkeys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">relevant_keys</span> 
                                   <span class="k">if</span> <span class="p">(</span><span class="n">parse_hdf5_key</span><span class="p">(</span><span class="n">k</span><span class="p">)[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">v</span>
                                       <span class="ow">or</span> <span class="n">parse_hdf5_key</span><span class="p">(</span><span class="n">k</span><span class="p">)[</span>
                                           <span class="s1">&#39;combined variable name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">v</span><span class="p">)]</span>
                        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">crange</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">nochunks</span><span class="p">:</span>
                                <span class="n">key</span> <span class="o">=</span> <span class="n">varkeys</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">key</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">varkeys</span> 
                                        <span class="k">if</span> <span class="n">parse_hdf5_key</span><span class="p">(</span><span class="n">k</span><span class="p">)[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">c</span><span class="p">]</span>
                                
                            <span class="c1"># should be only one key</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">other</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; it=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">key</span><span class="p">]</span>
                                <span class="n">is_rest_same</span> <span class="o">=</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span>
                                    <span class="p">[</span><span class="n">other</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">other</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> 
                                     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)])</span> 
                                     <span class="o">==</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                                <span class="k">if</span> <span class="n">is_rest_same</span><span class="p">:</span>
                                    <span class="n">mult_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; it=&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> 
                                                 <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">key</span><span class="p">]</span>
                                    <span class="n">var</span><span class="p">[</span><span class="n">vi</span><span class="p">]</span> <span class="o">=</span> <span class="n">mult_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                    <span class="n">var</span> <span class="o">+=</span> <span class="n">mult_vars</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                                    <span class="n">v</span> <span class="o">=</span> <span class="n">mult_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                                    <span class="n">key</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">varkeys</span>
                                           <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">k</span><span class="p">]</span>
                                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                            <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                                            <span class="o">+</span> <span class="s1">&#39; keys found for variable &#39;</span>
                                            <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> it=</span><span class="si">{}</span><span class="s1"> rl=</span><span class="si">{}</span><span class="s1"> c=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                <span class="n">v</span><span class="p">,</span> <span class="n">iit</span><span class="p">,</span> <span class="n">rl</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
                                            <span class="o">+</span> <span class="s1">&#39; found: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                        <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                                        <span class="o">+</span> <span class="s1">&#39; keys found for variable &#39;</span>
                                        <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> it=</span><span class="si">{}</span><span class="s1"> rl=</span><span class="si">{}</span><span class="s1"> c=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                            <span class="n">v</span><span class="p">,</span> <span class="n">iit</span><span class="p">,</span> <span class="n">rl</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
                                        <span class="o">+</span> <span class="s1">&#39; found: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            
                            <span class="c1"># Read in the variable</span>
                            <span class="k">if</span> <span class="n">veryextraverbose</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reading key = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> 
                                      <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="n">var_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

                            <span class="c1"># Cut off ghost grid points</span>
                            <span class="n">ghost_x</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;cctk_nghostzones&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">ghost_y</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;cctk_nghostzones&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">ghost_z</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;cctk_nghostzones&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                            <span class="n">var_array</span> <span class="o">=</span> <span class="n">var_array</span><span class="p">[</span><span class="n">ghost_z</span><span class="p">:</span><span class="o">-</span><span class="n">ghost_z</span><span class="p">,</span> 
                                                  <span class="n">ghost_y</span><span class="p">:</span><span class="o">-</span><span class="n">ghost_y</span><span class="p">,</span> 
                                                  <span class="n">ghost_x</span><span class="p">:</span><span class="o">-</span><span class="n">ghost_x</span><span class="p">]</span>
                            <span class="n">iorigin</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;iorigin&#39;</span><span class="p">])</span>
                            <span class="n">var_chunks</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">{})[</span><span class="n">iorigin</span><span class="p">]</span> <span class="o">=</span> <span class="n">var_array</span>
                        
                    <span class="k">if</span> <span class="n">collect_time</span><span class="p">:</span>
                        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]]</span>
                        <span class="n">collect_time</span> <span class="o">=</span> <span class="kc">False</span>
                    
            <span class="c1"># Join chunks, fix indexing and save in data dictionary</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">var</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">veryextraverbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Joining chunks for </span><span class="si">{}</span><span class="s1"> at it = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">iit</span><span class="p">),</span> 
                          <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">aurel_v</span> <span class="o">=</span> <span class="n">transform_vars_ET_to_aurel</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="n">varlist</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">aurel_v</span><span class="p">,</span> <span class="p">[])</span>
                <span class="n">varlist</span> <span class="o">+=</span> <span class="p">[</span><span class="n">fixij</span><span class="p">(</span><span class="n">join_chunks</span><span class="p">(</span>
                            <span class="n">var_chunks</span><span class="p">[</span><span class="n">v</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Could not find checkpoint file for&#39;</span>
                    <span class="o">+</span> <span class="s1">&#39; it=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iit</span><span class="p">),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                           
    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="fixij">
<a class="viewcode-back" href="../../source/reading.html#aurel.reading.fixij">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">fixij</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fix the x-z indexing as you read in the data.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span></div>


<div class="viewcode-block" id="join_chunks">
<a class="viewcode-back" href="../../source/reading.html#aurel.reading.join_chunks">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">join_chunks</span><span class="p">(</span><span class="n">cut_data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Join the chunks of data together.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cut_data : dict of dict</span>
<span class="sd">        A dictionary containing the data from the simulation output files.</span>
<span class="sd">        dict.keys() = tuple of the chunks &#39;iorigin&#39; attribute </span>
<span class="sd">        which maps out how the data is to be joined together.</span>

<span class="sd">    Other Parameters</span>
<span class="sd">    ----------------</span>
<span class="sd">    veryextraverbose : bool, optional</span>
<span class="sd">        If True, print additional information during the joining process.</span>
<span class="sd">        The default is False.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    uncut_data : array_like</span>
<span class="sd">        The data now joined together.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">veryextraverbose</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;veryextraverbose&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="n">all_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cut_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">cmax</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_keys</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">veryextraverbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;There are </span><span class="si">{</span><span class="n">cmax</span><span class="si">}</span><span class="s1"> chunks, here are their keys and shape&#39;</span><span class="p">,</span> 
              <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_keys</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">cut_data</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
    <span class="c1"># =================</span>
    <span class="k">if</span> <span class="n">cmax</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">uncut_data</span> <span class="o">=</span> <span class="n">cut_data</span><span class="p">[</span><span class="n">all_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="k">elif</span> <span class="n">cmax</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">uncut_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">cut_data</span><span class="p">[</span><span class="n">all_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">cut_data</span><span class="p">[</span><span class="n">all_keys</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">cmax</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">uncut_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cut_data</span><span class="p">[</span><span class="n">all_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">cut_data</span><span class="p">[</span><span class="n">all_keys</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> 
            <span class="n">cut_data</span><span class="p">[</span><span class="n">all_keys</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># =================</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># --- Append along axis = 2</span>
        <span class="k">if</span> <span class="n">veryextraverbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Appending along axis = 2&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># First make groups to be appended together</span>
        <span class="n">ndata_groups</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">all_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">ndata_groups</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">ndata_groups</span><span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">:]][</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">cut_data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ndata_groups</span><span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">cut_data</span><span class="p">[</span><span class="n">k</span><span class="p">]}</span>
        <span class="k">if</span> <span class="n">veryextraverbose</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ndata_groups</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">shapes</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> 
                          <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">ndata_groups</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Group </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> has elements with shapes: </span><span class="si">{</span><span class="n">shapes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> 
                      <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># Then append them together</span>
        <span class="n">ndata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k12</span> <span class="ow">in</span> <span class="n">ndata_groups</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">all_k0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">ndata_groups</span><span class="p">[</span><span class="n">k12</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="n">ndata</span><span class="p">[</span><span class="n">k12</span><span class="p">]</span> <span class="o">=</span> <span class="n">ndata_groups</span><span class="p">[</span><span class="n">k12</span><span class="p">][</span><span class="n">all_k0</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">k0</span> <span class="ow">in</span> <span class="n">all_k0</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="k">if</span> <span class="n">veryextraverbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Appending shape </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">ndata</span><span class="p">[</span><span class="n">k12</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
                          <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; with shape </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">ndata_groups</span><span class="p">[</span><span class="n">k12</span><span class="p">][</span><span class="n">k0</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> 
                          <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">ndata</span><span class="p">[</span><span class="n">k12</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">ndata</span><span class="p">[</span><span class="n">k12</span><span class="p">],</span> <span class="n">ndata_groups</span><span class="p">[</span><span class="n">k12</span><span class="p">][</span><span class="n">k0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                
        <span class="n">all_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ndata</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">del</span> <span class="n">cut_data</span><span class="p">,</span> <span class="n">ndata_groups</span>

        <span class="k">if</span> <span class="n">veryextraverbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; === Key and shape after 1st append&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_keys</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">ndata</span><span class="p">[</span><span class="n">k</span><span class="p">]),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># --- Append along axis = 1</span>
        <span class="k">if</span> <span class="n">veryextraverbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Appending along axis = 1&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># First make groups to be appended together</span>
        <span class="n">nndata_groups</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">all_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">nndata_groups</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">nndata_groups</span><span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ndata</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nndata_groups</span><span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">ndata</span><span class="p">[</span><span class="n">k</span><span class="p">]}</span>
        <span class="k">if</span> <span class="n">veryextraverbose</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">nndata_groups</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">shapes</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> 
                          <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">nndata_groups</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Group </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> has elements with shapes: </span><span class="si">{</span><span class="n">shapes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> 
                      <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Then append them together</span>
        <span class="n">nndata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k2</span> <span class="ow">in</span> <span class="n">nndata_groups</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">all_k1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">nndata_groups</span><span class="p">[</span><span class="n">k2</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="n">nndata</span><span class="p">[</span><span class="n">k2</span><span class="p">]</span> <span class="o">=</span> <span class="n">nndata_groups</span><span class="p">[</span><span class="n">k2</span><span class="p">][</span><span class="n">all_k1</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">k1</span> <span class="ow">in</span> <span class="n">all_k1</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="k">if</span> <span class="n">veryextraverbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Appending shape </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">nndata</span><span class="p">[</span><span class="n">k2</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
                          <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; with shape </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">nndata_groups</span><span class="p">[</span><span class="n">k2</span><span class="p">][</span><span class="n">k1</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> 
                          <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">nndata</span><span class="p">[</span><span class="n">k2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">nndata</span><span class="p">[</span><span class="n">k2</span><span class="p">],</span> <span class="n">nndata_groups</span><span class="p">[</span><span class="n">k2</span><span class="p">][</span><span class="n">k1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="n">all_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nndata</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">del</span> <span class="n">ndata</span><span class="p">,</span> <span class="n">nndata_groups</span>
        
        <span class="k">if</span> <span class="n">veryextraverbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; === Key and shape after 2nd append&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_keys</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">nndata</span><span class="p">[</span><span class="n">k</span><span class="p">]),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                
        <span class="c1"># --- Append along axis = 0</span>
        <span class="k">if</span> <span class="n">veryextraverbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Appending along axis = 0&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">all_keys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">all_keys</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">all_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">uncut_data</span> <span class="o">=</span> <span class="n">nndata</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">all_keys</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="k">if</span> <span class="n">veryextraverbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Appending shape </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">uncut_data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; with shape </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">nndata</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> 
                        <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">uncut_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">uncut_data</span><span class="p">,</span> <span class="n">nndata</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">nndata</span>
        
        <span class="k">if</span> <span class="n">veryextraverbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; === Final shape after 3rd append&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">uncut_data</span><span class="p">),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">uncut_data</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Robyn L. Munoz.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>